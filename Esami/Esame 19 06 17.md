# Esame 17.6.19

**SpecificaStatiClasse** Giocatore

Stati: {RIPOSO, INGIOCO}

Variabili di stato ausiliarie:\
&nbsp;&nbsp;&nbsp;&nbsp;   punteggio: intero

Stato iniziale:\
&nbsp;&nbsp;&nbsp;&nbsp;   statoiniziale = Stato.RIPOSO\
&nbsp;&nbsp;&nbsp;&nbsp;   punteggio = 0;

**SpecificaTransizioneClasse** Giocatore

Transizione: Riposo → InGioco\
&nbsp;&nbsp;&nbsp;&nbsp;   siGioca()

Evento: SiGioca

Condizione: -

Azione:\
&nbsp;&nbsp;&nbsp;&nbsp;   pre: -\
&nbsp;&nbsp;&nbsp;&nbsp;   post: this e casella zero sono collegati da un link di tipo Posizione

Transizione: InGioco → InGioco\
&nbsp;&nbsp;&nbsp;&nbsp;   lancioDelDado(n)

Evento: LancioDelDado(n: intero)

Condizione: -

Azione:\
&nbsp;&nbsp;&nbsp;&nbsp;   pre: -\
&nbsp;&nbsp;&nbsp;&nbsp;   post: pre(Posizione) == null and:\
se la casella è di tipo normale o bonus: this e pre(casella) +n sono collegati da un link di tipo Posizione, inoltre se la casella è di tipo bonus, punteggio == pre(punteggio) + casella.punti;\ 
se la casella è di tipo salto, this e casella.getCasella() sono collegati da un link di tipo Posizione

Transizione: InGioco → Riposo\
&nbsp;&nbsp;&nbsp;&nbsp;   fine()

Evento: Fine

Condizione: -

Azione: -\
&nbsp;&nbsp;&nbsp;&nbsp;   pre: - \
&nbsp;&nbsp;&nbsp;&nbsp;   post: -

**FineSpecifica**

**SegnaturaAttivitaComplesse**

AttivitaPrincipale(T: Tabellone): ();

SottoAttivita1(T: Tabellone): ();

SottoAttivita2(T: Tabellone): (report: stringa);

**SegnaturaAttivitaAtomiche**

Verifica(T: Tabellone): (ok: boolean);

AvviaGioco(T: Tabellone): ();

Analisi(T: Tabellone): (report: stringa);

CalcolaPunti(T: Tabellone): (punti: stringa);

**SegnaliIO**

Errore(): ();

Attesa(): ();

Report(punti: stringa, reportAnalisi: stringa): ();

**FineSegnatura**

```jsx
package Giocatore;
public class Giocatore implements Listener {
	private String nome;
	private TipoLinkGioca gioca;
	private Casella posizione;
	private final int MIN_GIOCA = 1;
	private final int MIN_POSIZIONE = 1;
	
	public Giocatore(String n) {nome = n;}
	
	public String getNome() {return nome;}

	public int quantiGioca() {
		if (gioca == null) return 0;
		return 1;
	}
	public int quantiPosizione() {
		if (posizione == null) return 0;
		return 1;
	}

	public void inserisciLinkGioca(TipoLinkGioca l) {
		if (l != null && l.getGiocatore() == this)
			ManagerGioca.inserisci(l);
	}
	public void eliminaLinkGioca(TipoLinkGioca l) {
		if (l != null && l.getGiocatore() == this)
			ManagerGioca.elimina(l);
	}
	public TipoLinkGioca getLinkGioca() {
		if (quantiGioca == 0)
			throw new RuntimeException("violata cardinalità 1..1");
		return gioca;
	}
	public void inserisciPerManagerGioca(ManagerGioca m) {
		if (m != null)
			gioca = m.getLink();
	}
	public void eliminaPerManagerGioca(ManagerGioca m) {
		if (m != null)
			gioca = null;
	}

	public void setPosizione(Casella c) {posizione = c;}
	public Casella getPosizione() {
		if (quantiPosizione == 0)
			throw new RuntimeException("violata cardinalità 1..1");
		return posizione;
	}
	
	public static enum Stato =  {RIPOSO, INGIOCO};
	int punteggio;
	Stato statocorrente = Stato.RIPOSO;
	public Stato getStato() {return statocorrente;}

	public void fired(Evento e) {
		TaskExecutor.getInstance().perform(new GiocatoreFired(this, e));
	}
}
```

```jsx
package Giocatore;
class GiocatoreFired extends Task {
	private boolean eseguita = false;
	private Giocatore giocatore;
	private Evento e;
	public GiocatoreFired(Giocatore g, Evento e) {
		giocatore = g;
		this.e = e;
	}
	public synchronized void esegui() {
		if (eseguita || e.getDestinatario != null && e.getDestinatario != giocatore)
			return;
		eseguita = true;
		
		switch(giocatore.getStato()) {
			case RIPOSO:
				if (e.getClass().equals(SiGioca.Class)) {
					Tabellone t = giocatore.getLinkGioca().getTabellone();
					Casella c = t.getLinkFormato().get(0).getCasella();
					giocatore.setPosizione(c);
					giocatore.punteggio = 0;
					giocatore.statocorrente = Stato.INGIOCO;
				}
				break;
			case INGIOCO:
				if (e.getClass().equals(LancioDado.Class)) {
					LancioDado d = (LancioDado)e;
					int n = d.getPlayload();
					int index_partenza;
					int index_arrivo;
					LinkedList<TipoLinkFormato> caselle = giocatore.getLinkGioca().getTabellone().getLinkFormato();
					for (TipoLinkFormato l : caselle) {
						Casella c = l.getCasella();
						if (c == giocatore.getPosizione())
							index_partenza = caselle.idexOf(l) + 1;
					}
					if (index_partenza + n > caselle.size()) {
						index_arrivo = index_partenza + n - caselle.size();
					}
					else {index_arrivo = index_partenza + n;}
					
					Casella arrivo = caselle[index_arrivo].getCasella();
					if (arrivo.getClass == CasellaSalto.class) {
						CasellaSalto salto = (CasellaSalto) arrivo;
						index_arrivo = salto.getSalta();
						giocatore.setPosizione(caselle[index_arrivo].getCasella());
					}
					else {
						giocatore.setPosizione(arrivo);
						if (arrivo.getClass == CasellaBonus.class) {
							CasellaBonus bonus = (CasellaBonus) arrivo;
							giocatore.punteggio += bonus.getPuntiBonus();
						}
					}
					giocatore.statocorrente = Stato.INGIOCO;
				}
				if (e.getClass().equals(Fine.class)) 
					giocatore.statocorrente = Stato.RIPOSO;
				break;
			default: throw new RuntimeException("stato non trovato");
		}
	}
	public synchronized boolean estEseguita() {return eseguita;}
}		
```

Associazione gioca (responsabilità doppia, 2..* ←-→ 1..1)

```jsx
public class TipoLinkGioca {
	private final Giocatore giocatore;
	private final Tabellone tabellone;
	
	public TipoLinkGioca(Giocatore g, Tabellone t) {
		if (g == null || t == null)
			throw new RuntimeException("link non valido");
		giocatore = g;
		tabellone = t;
	}
	public Giocatore getGiocatore() {return giocatore;}
	public Tabellone getTabellone() {return tabellone;}
	
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass())) {
			TipoLinkGioca l = (TipoLinkGioca) o;
			return l.giocatore == giocatore && l.tabellone == tabellone;
		}
		return false;
	}
	public int hashCode() {return giocatore.hashCode() + tabellone.hashCode();}
}
```

```jsx
public final class ManagerGioca {
	private TipoLinkGioca link;
	private ManagerGioca(TipoLinkGioca l) {link = l;}
	public TipoLinkGioca getLink() {retun link;}
	
	public static void inserisci(TipoLinkGioca l) {
		if (l != null && l.getGiocatore.quantiGioca == 0) {
			ManagerGioca m = new ManagerGioca(l);
			l.getGiocatore().inserisciPerManagerGioca(m);
			l.getTabellone().inserisciPerManagerGioca(m);
		}
	}
	public static void elimina(TipoLinkGioca l) {
		if (l != null && l.getGiocatore().getLinkGioca().equals(l)) {
			ManagerGioca m = new ManagerGioca(l);
			l.getGiocatore().eliminaPerManagerGioca(m);
			l.getTabellone().eliminaPerManagerGioca(m);
		}
	}
}
```

```jsx
package attivita_complesse;
public class AttivitaPrincipale implements Runnable {
	private boolean eseguita = false;
	private Tabellone T;
	
	public AttivitaPrincipale(Tabellone T) {this.T = T;}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
	
		Verifica v = new Verifica(T);
		TaskExecutor.getInstance().perform(v);
		boolean ok = v.getResult();
		
		SottoAttivita1 ramo1 = new SottoAttivita1(T);
		Thread t1 = new Thread(ramo1);
		t1.start();
		SottoAttivita2 ramo2 = new SottoAttivita2(T);
		Thread t2 = new Thread(ramo2);
		t2.start();
		
		try {
			t1.join();
			t2.join();
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		
		CalcolaPunti cp = new CalcolaPunti(T);
		TaskExecutor.getInstance().perform(cp);
		String punti = cp.getResult();
		String report = ramo2.getResult();
		
		SegnaliIO.report(punti, report);
	}
	public synchronized boolean estEseguita() {return eseguita;}
}	
```

```jsx
package attivita_complesse;
public class SottoAttivita1 implements Runnable {
	private boolean eseguita = false;
	private Tabellone T;
	
	public SottoAttivita1(Tabellone T) {this.T = T;}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
		
		AvviaGioco ag = new AvviaGioco(Tabellone T);
		TaskExecutor.getInstance().perform(ag);
		SegnaliIO.attesa();
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

```jsx
package attivita_complesse;
public class SottoAttivita2 implements Runnable {
	private boolean eseguita = false;
	private Tabellone T;
	private String ris;
	
	public SottoAttivita2(Tabellone T) {
		if (eseguita) return;
		eseguita = true;
		
		Analisi a = new Analisi(Tabellone T);
		TaskExecutor.getInstance().perform(a);
		ris = a.getResult();
	}
	public boolean estEseguita() {return eseguita;}
	public String getResult() {
		if (!eseguita)
			throw new RuntimeException("sotto attivita 2 non eseguita");
		return ris;
	}
}
```
