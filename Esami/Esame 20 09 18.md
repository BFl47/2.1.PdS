# Esame 18.9.20

**SpecificaStatiClasse** Autista

Stati: {RIPOSO, ATTESA}

Variabili di stato ausiliarie:\
&nbsp;&nbsp;&nbsp;&nbsp;   data: Data;\
&nbsp;&nbsp;&nbsp;&nbsp;   cliente: Cliente;

Stato iniziale:\
&nbsp;&nbsp;&nbsp;&nbsp;   statocorrente = Stato.RIPOSO;\
&nbsp;&nbsp;&nbsp;&nbsp;   data: -;\
&nbsp;&nbsp;&nbsp;&nbsp;   cliente: -;

**FineSpecificaStati**

**SegnaturaAttivitaComplesse**

AttivitaPrincipale(insP: insieme(Prenotazione)) : ();

A(insP: insieme(Prenotazione)) : (reportA: stringa);

B(insP: insieme(Prenotazione)): (reportB: stringa);

**SegnaturaAttivitaAtomiche**

Verifica(insP: insieme(Prenotazione)) : (ok: boolean);

Integrazione(reportA: stringa, reportB: stringa) : (report: stringa);

**SegnaturaSegnaliIO**

Errore(): ();

Stampa(report: stringa) : ();

**FineSegnatura**

```jsx
package Autista;
public class Autista implements Listener {
private String nome;
private String matricola;
private HashSet<TipoLinkPossiede> ins_possiede;
private HashSet<TipoLinkGuidatore> ins_guidatore;
private final int MIN_POSSIEDE = 1;
public int quantiPossiede() {return ins_possiede.size();}
public Autista(String n, String m) {
	nome = n;
	matricola = m;
	ins_possiede = new HashSet<TipoLinkPossiede>();
	ins_guidatore = new HashSet<TipoLinkGuidatore>();
}
public String getNome() {return nome;}
public String getMatricola() {return matricola;}

public void inserisciLinkPossiede(TipoLinkPossiede l) {
	if (l != null && l.getAutista() == this)
		ManagerPossiede.inserisci(l);
}
public void eliminaLinkPossiede(TipoLinkPossiede l) {
	if (l != null && l.getAutista() == this)
		ManagerPossiede.elimina(l);
}
public Set<TipoLinkPossiede> getLinkPossiede() {
	if (quantiPossiede() < MIN_POSSIEDE)
		throw new RuntimeException("violata cardinalità 1..*");
	return (HashSet<TipoLinkPossiede>) ins_possiede.clone();
}
public void inserisciPerManagerPossiede(ManagerPossiede m) {
	if (m != null)
		ins_possiede.add(m.getLink());
}
public void eliminaPerManagerPossiede(ManagerPossiede m) {
	if (m != null)
		ins_possiede.remove(m.getLink());
}
public void inserisciLinkGuidatore(TipoLinkGuidatore l) {
	if (l != null && l.getAutista() == this)
		ManagerGuidatore.inserisci(l);
}
public void eliminaLinkGuidatore(TipoLinkGuidatore l) {
	if (l != null && l.getAutista() == this)
		ManagerGuidatore.elimina(l);
}
public Set<TipoLinkGuidatore> getLinkGuidatore() {
	return (HashSet<TipoLinkGuidatore>) ins_guidatore.clone();
}
public void inserisciPerManagerGuidatore(ManagerGuidatore m) {
	if (m != null)
		ins_guidatore.add(m.getLink());
}
public void eliminaPerManagerGuidatore(ManagerGuidatore m) {
	if (m != null)
		ins_guidatore.remove(m.getLink());
}

//gestione stato
public static enum Stato = {RIPOSO, ATTESA};
Stato statocorrente = Stato.RIPOSO;
int giorno, mese, anno;
Cliente cliente;

//gestione transizioni
public void fired(Evento e) {
	TaskExecutor.getInstance().perform(new AutistaFired(this, e));
}
```

```jsx
package Autista;
public class AutistaFired implements Task {
	private boolean eseguita = false;
	private Autista autista;
	private Evento e;
	
	public AutistaFired(Autista a, Evento e) {
		this.autista = a;
		this.e = e;
	}
	public synchronized void esegui() {
		if (eseguita || (e.getDestinatario() != null && e.getDestinatario() != autista))
			return;
		eseguita = true;
	
		switch(a.getStato()) {
			case RIPOSO:
				if (e.getClass() == Richiesta.class) {
					Richiesta r = (Richiesta)e;
					boolean occupato;
					for (TipoLinkPrenotazione l: autista.getLinkPrenotazione()) {
						Prenotazione p = l.getPrenotazione();
						if (r.getGiorno() == p.getGiorno() && r.getMese() == p.getMese() && r.getAnno() == p.getAnno) 
							occupato = true;
					}
					if (occupato) {
						Occupato o = new Occupato(autista, r.getMittente());
						Environment.aggiungiEvento(o);
						autista.statocorrente = Stato.RIPOSO;
					}
					else {
						autista.giorno = r.getGiorno();
						autista.mese = r.getMese();
						autista.anno = r.getAnno();
						autista.cliente = r.getMittente());
						MostraAuto m = new MostraAuto(autista, autista.cliente);
						autista.statocorrente = Stato.ATTESA;
					}
				}
				break;
			case ATTESA:
				if (e.getClass() == Conferma.class) {
					Conferma c = (Conferma) o;
					if (c.getMittente() != autista.cliente) {
						SegnalaErrore se = new SegnalaErrore(autista, c.getMittente());
						Environment.aggiungiEvento(se);
						autista.statocorrente = Stato.ATTESA;
					}
					else {
						Auto autoscelta = c.getPlayload();
			//suppongo che nel costruttore di prenotazione sia richiesta solo la data e che il codice verrà generato
			//al momento della creazione di p dal sistema
						Prenotazione p = new Prenotazione(autista.giorno, autista.mese, autista.anno);
						p.inserisciTipoLinkGuidatore(new TipoLinkGuidatore(autista, p));
						p.inserisciTipoLinkVeicolo(new TipoLinkVeicolo(autoscelta, p));
						autista.cliente.setPrenotazione(p);
						autista.statocorrente = Stato.RIPOSO;
					}
				}
				break;
			default: throw new RuntimeException("stato non riconosciuto");
		}
	}
	public synchronized boolean estEseguita() {return eseguita;}
		
```

```jsx
package AutistaLimo;
import Autista.*;
public class AutistaLimo extends Autista {
	private double lunghezza;
	public AutistaLimo(String n, String m, String l) {
		super(n, m);
		lunghezza = l;
	}
	public double getLunghezza() {return lunghezza;}
	public void setLunghezza(double l) {lunghezza = l;}
}
```

Associazione Possiede (doppia responsabilità, 1..1 ←-→ 1..*)

```jsx
public class TipoLinkPossiede {
	private final Autista autista;
	private final Auto auto;
	public TipoLinkPossiede(Autista autista, Auto auto) {
		if (autista == null || auto == null)
			throw new RuntimeException("link non valido");
		this.autista = autista;
		this.auto = auto;
	}
	public Autista getAutista() {return autista;}
	public Auto getAuto() {return auto;}
	
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass())) {
			TipoLinkPossiede l = (TipoLinkPossiede)o;
			return l.autista == this.autista && l.auto == this.auto;
		}
		return false;
	}
	public int hashCode() {return this.autista.hashCode() + this.auto.hashCode();}
}
```

```jsx
public final class ManagerPossiede {
	private TipoLinkPossiede link;
	private ManagerPossiede(TipoLinkPossiede l) {link = l;}
	public TipoLinkPossiede getLink() {return link;}
		
	public static void inserisci(TipoLinkPossiede l) {
		if (l != null) {
			ManagerPossiede m = new ManagerPossiede(l);
			l.getAutista().inserisciPerManagerPossiede(m);
			l.getAuto().inserisciPerManagerPossiede(m);
		}
	}
	public static void elimina(TipoLinkPossiede l) {
		if (l != null) {
			ManagerPossiede m = new ManagerPossiede(l);
			l.getAutista().inserisciPerManagerPossiede(m);
			l.getAuto().inserisciPerManagerPossiede(m);
		}
	}
}
```

```jsx
package attivita_complesse;
public class AttivitaPrincipale implements Runnable {
	private boolean eseguita = false;
	private HashSet<Prenotazione> insP;
	
	public AttivitaPrincipale(HashSet<Prenotazione> insP) {
		this.insP = insP;
	}
	public synchronized void run() {
		if (eseguita)
			return;
		eseguita = true;
	
		Verifica v = new Verifica(insP);
		TaskExecutor.getInstance().perform(v);
		boolean ok = v.getResult();
		
		if (!ok) {
			SegnaliIO.errore();
			return;
		}
		
		A ramo1 = new A(insP);
		Thread t1 = new Thread(ramo1);
		t1.start();
		B ramo2 = new B(insP);
		Thread t2 = new Thread(ramo2);
		t2.start();
		
		try {
			t1.join();
			t2.join();
		} catch(InterruptedException e) {
			e.printStackTrace();
		}
		String reportA = ramo1.getResult();
		String reportB = ramo2.getResult();
		Integrazione i = new Integrazione(reportA, reportB);
		TaskExecutor.getInstance().perform(i);
		String r = i.getResult();
		SegnaliIO.stampa(r);
	}
	public synchronized estEseguita() {return eseguita;}
}
```

```jsx
package attivita_atomiche;
public class Verifica implements Task {
	private boolean eseguita = false;
	private HashSet<Prenotazione> insP;
	private boolean ok = true;
	
	public Verifica(HashSet<Prenotazione> insP) {
		this.insP = insP;
	}
	public synchronized void esegui() {
		if (eseguita) return;
		eseguita = true;
		
		for (Prenotazione p: insP) {
			Autista autista = p.getLinkGuidatore().getAutista();
			Auto auto = p.getAuto();
			for (TipoLinkPossiede l: autista.getLinkPossiede()) {
				if (l.getAuto() != auto)
					ok = false;
			}
		}
	}
	public synchronized boolean getResult() {
		if (!eseguita)
			throw new RuntimeException("attività Verifica non eseguita");
		return ok;
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```
