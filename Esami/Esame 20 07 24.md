# Esame 24.7.20

**SpecificaStatiClasse** Idea

Stati: {CREATA, SOSTENUTA, ATTESA, CHIUSA}

Variabili di stato ausiliarie:
     lavoratore: Creatore

Stato iniziale
     statocorrente: Stato.CREATA
     lavoratore: -

**FineSpecifica**

**SegnaturaAttivitaComplesse**

Rilascio(campagna: CampagnaP) : ();

Pubblicazione(campagna: CampagnaP) : (elencoIdee: stringa);

InserimentoPubblicita(campagna: CampagnaP) : (elencoPubblicita: stringa);

**SegnaturaAttivitaAtomiche**

Verifica(campagna: CampagnaP) : (ok: boolean);

**Segnatura SegnaliIO**

Errore() : ();

Rapporto(elencoIdee: stringa, elencoPubblicita: stringa) : ();

**FineSegnatura**

```jsx
package Idea;
public class Idea implements Listener {
	private String titolo;
	private String descrizione;
	private TipoLinkCrea linkCrea;
	private TipoLinkAssociata linkAssociata;
	
	private final int MIN_CREA = 1;
	private final int MIN_ASSOCIATA = 1;
	
	public int quantiCrea() {
		if (linkCrea == null) return 0;
		return 1;
	}
	public int quantiAssociata() {
		if (linkAssociata == null) return 0;
		return 1;
	}
	public Idea(String t, String d) {
		titolo = t;
		descrizione = d;
	}
	public String getTitolo() {return titolo;}
	public String getDescrizione() {return descrizione;}
	public void setDescrizione(String d) {descrizione = d;}

	public void inserisciTipoLinkCrea(TipoLinkCrea l) {
		if (l != null && l.getIdea() == this)
			ManagerCrea.inserisci(l);
	}
	public void eliminaTipoLinkCrea(TipoLinkCrea l) {
		if (l != null && l.getIdea() == this)
			ManagerCrea.elimina(l);
	}
	public TipoLinkCrea getLinkCrea() {
		if (linkCrea == null)
			throw new RuntimeException("violata cardinalità 1..1");
		return linkCrea;
	}
	public void inserisciPerManagerCrea(ManagerCrea m) {
		if (m != null)
			linkCrea = m.getLink();
	}
	public void eliminaPErManagerCrea(ManagerCrea m) {
		if (m != null)
			linkCrea = null;
	}
	public void inserisciTipoLinkAssociata(TipoLinkAssociata l) {
		if (l != null && l.getIdea() == this)
			ManagerAssociata.inserisci(l);
	}
	public void eliminaTipoLinkAssociata(TipoLinkAssociata l) {
		if (l != null && l.getIdea() == this)
			ManagerAssociata.elimina(l);
	}
	public TipoLinkAssociata getLinkAssociata() {
		if (linkAssociata == null)
			throw new RuntimeException("violata cardinalità 1..1");
		return linkAssociata;
	}
	public void inserisciPerManagerAssociata(ManagerAssociata m) {
		if (m != null)
			linkAssociata = m.getLink();
	}
	public void eliminaPerManagerAssociata(ManagerAssociata m) {
		if (m != null)
			linkAssociata = null;
	}
	
	//gestione stato
	public static enum Stato = {CREATA, SOSTENUTA, ATTESA, CHIUSA};
	Stato statocorrente = Stato.CREATA;
	Crativo lavoratore;
	public Stato getStato() {return statocorrente;}
	
	//gestione transizioni
	public void fired(Evento e) {
		TaskExecutor.getInstance().perform(new IdeaFired(this, e));
	}
```

```jsx
package Idea;
public class IdeaFired implements Task {
	private boolean eseguita = false;
	private Idea idea;
	private Evento e;
	
	public IdeaFired(Idea i, Evento e) {
		idea = i;
		this.e = e;
	}
	public synchronized void esegui() {
		if (eseguita || (e.getDestinatario() != null && e.getDestinatario() != idea))
			return;
		eseguita = true;
		
		switch(idea.getStato()) {
			case CREATA:
				if (e.getClass() == Chiudi.class)
						idea.statocorrente = Stato.CHIUSA;
				else if (e.getClass() == Sostieni.class)
						idea.statocorrente = Stato.SOSTENUTA;
				break;
			case SOSTENUTA:
				if (e.getClass() == Chiudi.class)
					idea.statocorrente = Stato.CHIUSA;
				else if (e.getClass() == Approfondimenti.class) {
					Approfondimenti a = (Approfondimenti)e;
					idea.lavoratore = a.getMittente();
					RichiestaAgg ra = new RichiestaAgg(idea.lavoratore, idea.getLinkCreata().getCreatore());
					Environment.aggiungiEvento(ra);
					idea.statocorrenet = Stato.ATTESA;
				}
				break;
			case ATTESA:
				if (e.getClass() == Chiudi.class) {
					NotificaChiusura nc = new NotificaChiusura(idea, idea.lavoratore);
					Environment.aggiungiEvento(nc);
					idea.lavoratore = null;
					idea.statocorrente = Stato.CHIUSA;
				}
				else if (e.getClass() == Aggiorna.class) {
					Aggiorna a = (Aggiorna)e;
					String nuovadescrizione = a.getPlayload();
					idea.setDescrizione(nuovadescrizione);
					NotificaAgg na = new NotificaAgg(idea, idea.lavoratore);
					idea.lavoratore = null;
					idea.statocorrente = Stato.SOSTENUTA;
				}
				break;
			case CHIUSA:
				break;
			default: throw new RuntimeException("stato non riconosciuto");
		}
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

```jsx
package IdeaDirompente;
import Idea.*;
public class IdeaDirompente extends Idea {
	private String cambiamento;
	public IdeaDirompente(String t, String d, String c) {
		super(t, d);
		cambiamento = c;
	}
	public String getCambiamento() {return cambiamento;}
}
```

associazione Crea (responsabilità doppia, 1..1 ←-→ 0..100)

```jsx
public class TipoLinkCrea {
	private final Idea idea;
	private final Creativo creatore;
	public TipoLinkCrea(Idea i, Creativo c) {
		if (i == null || c == null)
			throw new RuntimeException("link non valido");
		idea = i;
		creatore = c;
	}
	public Idea getIdea() {return idea;}
	public Creativo getCreatore() {return creatore;}
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass()) {
			TipoLinkCrea l = (TipoLinkCrea) o;
			return l.idea == idea && l.creatore == creatore;
		}
		return false;
	}
	public int hashCode() {return idea.hashCode() + creatore.hashCode();}
}
```

```jsx
public final class ManagerCrea {
	private TipoLinkCrea link;
	private ManagerCrea(TipoLinkCrea l) {link = l;}
	public TipoLinkCrea getLink() {return link;}
	public static void inserisci(TipoLinkCrea l) {
		if (l != null && l.getIdea().quantiCrea() == 0) {
			ManagerCrea m = new ManagerCrea(l);
			l.getIdea().inserisciPerManagerCrea(m);
			l.getCreatore().inserisciPerManagerCrea(m);
		}
	}
	public static void elimina(TipoLinkCrea l) {
		if (l != null && l.getIdea().getLinkCrea().equals(l)) {
			ManagerCrea m = new ManagerCrea(l);
			l.getIdea().eliminaPerManagerCrea(m);
			l.getCreatore().eliminaPerManagerCrea(m);
		}
	}
}
```

associazione Associata (responsabilità doppia, 1..1 ←-→ 0..*)

```jsx
public class TipoLinkAssociata {
private final Idea idea;
private final CampagnaP campagnap;

public TipoLinkAssociata(Idea i, CampagnaP cp) {
	if (i == null || cp == null)
		throw new RuntimeException("link non valido");
	idea = i;
	campagnap = cp;
}
public Idea getIdea() {return idea;}
public CampagnaP getCampagnaP() {return campagnap;}

public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass()) {
			TipoLinkAssociata l = (TipoLinkAssociata) o;
			return l.idea == idea && l.campagnap == campagnap;
		}
		return false;
	}
	public int hashCode() {return idea.hashCode() + campagnap.hashCode();}
}
```

```jsx
public final class ManagerAssociata {
	private TipoLinkAssociata link;
	private ManagerAssociata(TipoLinkAssociata l) {link = l;}
	public TipoLinkAssociata getLink() {return link;}
	public static void inserisci(TipoLinkAssociata l) {
		if (l != null && l.getIdea().quantiAssociata == 0) {
			ManagerAssociata m = new ManagerAssociata(l);
			l.getIdea().inserisciPerManagerAssociata(m);
			l.getCampagnaP().inserisciPerManagerAssociata(m);
		}
	}
	public static void elimina(TipoLinkAssociata l) {
		if (l != null && l.getIdea().getLinkAssociata().equals(l)) {
			ManagerAssociata m = new ManagerAssociata(l);
			l.getIdea().eliminaPerManagerAssociata(m);
			l.getCampagnaP().eliminaPerManagerAssociata(m);
		}
	}
}
```

```jsx
package attivita_complesse;
public class Rilascio implements Runnable {
	private boolean eseguita = false;
	private CampagnaP cp;
	
	public Rilascio(CampagnaP cp) {
		this.cp = cp;
	}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
		
		Verifica v = new Verifica(cp);
		TaskExecutor.getInstance().peform(v);
		boolean ok = v.getResult();
		if (!ok) {
			SegnaliIO.errore();
			return;
		}
		Pubblicazione ramo1 = new Pubblicazione(cp);
		Thread t1 = new Thread(ramo1);
		t1.start();
		InserimentoPubblicita ramo2 = new InserimentoPubblicita(cp);
		Thread t2 = new Thread(ramo2);
		t2.start();
		
		try {
			t1.join();
			t2.join();
		} catch(InterruptedException e) {
			e.printStackTrace();
		}
		String idee = ramo1.getResult();
		String pubblicita = ramo2.getResult();
		
		SegnaliIO.stampa(idee, pubblicita);
	}
	public synchronized boolean estEseguita(){return eseguita;}
}
```

```jsx
package attivita_atomiche;
public class Verifica implements Task {
	private boolean eseguita = false;
	private CampagnaP cp;
	private boolean ok = true;
	
	public Verifica(CampagnaP cp) {this.cp = cp;}
	public void synchronized esegui() {
		if (eseguita) return;
		eseguita = true;
		
		for (TipoLinkAssociata l: cp.getLinkAssociata()) {
			Idea i = l.getIdea();
			if (i.getClass() == IdeaDirompente.class)
				ok = false;
		}
	}
	public synchronized boolean getResult() {
		if (!eseguita)
			throw new RuntimeException("attività Verifica non eseguita");
		return ok;
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```