# Esame 14.6.18

**SpecificaStatiClasse** Pilota

&nbsp;&nbsp;&nbsp;&nbsp;Stati: {BASE, ATTESADROIDE, ATTESAPASSEGGERO, INVOLO}

&nbsp;&nbsp;&nbsp;&nbsp;Variabili di stato ausiliarie:\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;passeggero: Passeggero

&nbsp;&nbsp;&nbsp;&nbsp;Stato iniziale:\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;statocorrente = Stato.BASE\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;passeggero: -

**SpecificaTransizioniClasse** Pilota

&nbsp;&nbsp;&nbsp;&nbsp;Transizione: Base → AttesaDroide\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;volare(astronave, passeggero)[pilotaabilitato]/chiedi() {dest: compagno}

&nbsp;&nbsp;&nbsp;&nbsp;Evento: Volare(astronave: Astronave, passeggero: Passeggero)

&nbsp;&nbsp;&nbsp;&nbsp;Condizione: <pilota, astronave> in “pilota”

&nbsp;&nbsp;&nbsp;&nbsp;Azione:\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pre: -\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post: pilota.passeggero == passeggero and nuovoevento == chiedi(){dest = pilota.getLinkCompagno().getDroide()}

&nbsp;&nbsp;&nbsp;&nbsp;Transizione: AttesaDroide → AttesaPasseggero\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;droidesalito()/chiedi() {dest: pilota.passeggero}

&nbsp;&nbsp;&nbsp;&nbsp;Evento: DroideSalito

&nbsp;&nbsp;&nbsp;&nbsp;Condizione: -

&nbsp;&nbsp;&nbsp;&nbsp;Azione: \
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pre: -\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post: nuovoevento == chiedi(){dest = pilota.passeggero}

&nbsp;&nbsp;&nbsp;&nbsp;Transizione: AttesaPasseggero → InVolo\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;passeggerosalito()

&nbsp;&nbsp;&nbsp;&nbsp;Evento: PasseggeroSalito

&nbsp;&nbsp;&nbsp;&nbsp;Condizione: -

&nbsp;&nbsp;&nbsp;&nbsp;Azione: \
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pre: -\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   post: -

&nbsp;&nbsp;&nbsp;&nbsp;Transizione: InVolo → Base\
&nbsp;&nbsp;&nbsp;&nbsp;   rientro()

&nbsp;&nbsp;&nbsp;&nbsp;Evento: Rientro

&nbsp;&nbsp;&nbsp;&nbsp;Condizione: -

&nbsp;&nbsp;&nbsp;&nbsp;Azione: \
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   pre: -\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   post: pilota.passeggero == null

**FineSpecifica**

**SpecificaAttivitaPrincipale**

AttivitaPrincipale(gioco: Gioco): ();

VariabiliProcesso\
&nbsp;&nbsp;&nbsp;&nbsp;gioco: Gioco\
&nbsp;&nbsp;&nbsp;&nbsp;ok: boolean\
&nbsp;&nbsp;&nbsp;&nbsp;report: String

InizioProcesso

Verifica(gioco) : (ok);

if (!ok) {\
&nbsp;&nbsp;&nbsp;&nbsp;SegnaliIO.errore();\
&nbsp;&nbsp;&nbsp;&nbsp;return;
}

fork {\
&nbsp;&nbsp;&nbsp;&nbsp;thread t1:  {\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Gioca(gioco): ();\
&nbsp;&nbsp;&nbsp;&nbsp;}\
&nbsp;&nbsp;&nbsp;&nbsp;thread t2: {\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Analisi(gioco) : ();\
&nbsp;&nbsp;&nbsp;&nbsp;}\
}

join t1, t2;

SegnaliIO.saluto(): ();

**FineProcesso**

**SpecificaAttivitaGioca**

Gioca(gioco: G) : ();

VariabiliProcesso\
&nbsp;&nbsp;&nbsp;&nbsp;gioco: G

InizioProcesso

Avvia(gioco): ();

SegnaliIO.attesa(): ();

FineProcesso

**SpecificaAttivitaAnalisi**

Analisi(gioco: G) : ();

VariabiliProcesso\
&nbsp;&nbsp;&nbsp;&nbsp;gioco: G\
&nbsp;&nbsp;&nbsp;&nbsp;report: stringa

InizioProcesso

AnalisiAtomica(gioco): (report);

SegnaliIO.report(report): ();

FineProcesso

**FineSpecifica**

```jsx
public class Pilota extends Giocatore implements Listener {
	int oreVolo;
	HashSet<Astronave> astronavi;
	HashSet<Droide> preferisce;
	TipoLinkCompagno linkCompagno;
	private final int MIN_ASTRONAVE = 1;
	private final int MIN_PREFERISCE = 1;
	private final int MIN_COMPAGNO = 1;

	public Pilota(String n, int o) {
		super(n);
		oreVolo = o;
		astronavi = new HashSet<Astronave>();
		volacon = new HashSet<Droide>();
	}
	
	public int getOreVolo() {return oreVolo;}
	public void incrementaOreVolo(int o) {oreVolo += o;}
	
	public int quanteAstronavi() {return astronavi.size();}
	public int quantiPreferisce() {return preferisce.size();}
	public int quantiCompagno() {
		if (linkCompagno == null) return 0;
		return 1;
	}
	
	public void inserisciAstronave(Astronave a) {
		if (a != null)
			astronavi.add(a);
	}
	public void eliminaAstronave(AStronave a) {
		if (a != null)
			astronavi.remove(a);
	}
	public Set<Astronave> getAstronavi() {
		if (quantiAstronavi() < MIN_ASTRONAVI) 
			throw new RuntimeException("violata cardinalità 1..*");
		return (HashSet<Astronave>) astronavi.clone();
	}
	
	public void inserisciPreferisce(Droide d) {
		if (d != null)
			preferisce.add(d);
	}
	public void eliminaPreferisce(Droide d) {
		if (d != null)
			preferisce.remove(d);
	}
	public Set<Droide> getPreferisce() {
		if (quantiPreferisci() < MIN_PREFERISCE)
			throw new RuntimeException("violata cardinalità 1..*");
		return (HashSet<Droide>) preferisce.clone();
	}
	
	public void inserisciLinkCompagno(TipoLinkCompagno l) {
		if (l != null && l.getPilota() == this)
			ManagerCompagno.inserisci(l);
	}
	public void eliminaLinkCompagno(TipoLinkCompagno l) {
		if (l != null && l.getPilota() == this) 
			ManagerCompagno.remove(l);
	}
	public TipoLinkCompagno getLinkCompagno() {
		if (linkCompagno == null)
			throw new RuntimeException("violata cardinalità 1..1");
		return linkCompagno;
	}
	public void inserisciPerManagerCompagno(ManagerCompagno m) {
		if (m != null && preferisce.contains(m.getLink().getDroide())) //controllo subset
			linkCompagno = m.getLink();
	}
	public void eliminaPerManagerCompagno(ManagerCompagno m) {
		if (m != null && preferisce.contains(m.getLink().getDroide())) //controllo subset
			linkCompagno = null;
	}

	public static enum Stato = {BASE, ATTESADRONE, ATTESAPASSEGGERO, INVOLO};
	Stato statocorrente = Stato.BASE;
	Passeggero passeggero;
	public Stato getStato() {return statocorrente;}

	public void fired(Evento e) {
		TaskExecutor.getInstance().perform(new PilotaFired(this, e));
	}
}
```

```jsx
package Pilota;
class PilotaFired implements Task {
	private boolean eseguita = false;
	private Pilota pilota;
	private Evento e;
		
	public PilotaFired(Pilota p, Evento e) {
		pilota = p;
		this.e = e;
	}
	public synchronized void esegui() {
		if (eseguita || e.getDestinatario() != null && e.getDestinatario() != pilota) 
			return;
		eseguita = true;
	
		switch(pilota.getStato()) {
			case BASE:
				if (e.getClass() == Volare.class) {
					Volare v = (Volare) e;
					Astronave a = v.getAstronave();
					if (pilota.getAstronavi().contains(a)) {
						pilota.passeggero = v.getPasseggero();
						Chiedi c = new Chiedi(pilota, pilota.getLinkCompagno().getDroide());
						Environment.aggiungiEvento(c);
						pilota.statocorrente = Stato.ATTESADROIDE;
					}
				}
				break;
			case ATTESADROIDE:
			 if (e.getClass() == DroideSalito.class) {
					Chiedi c = new Chiedi(pilota, pilota.passeggero);
					Environment.aggiungiEvento(c);
					pilota.statocorrente = Stato.ATTESAPASSEGGERO;
				}
				break;
			case ATTESAPASSEGGERO:
				if (e.getClass() == PasseggeroSalito.class) 
					pilota.statocorrente = Stato.INVOLO;
				break;
			case INVOLO:
				if (e.getClass() == Rientro.class)
					pilota.statocorrente = Stato.BASE;
				break;
			default: throw new RuntimeException("stato non riconosciuto");
		}
	}
	public synchronized boolean estEseguita() {return eseguita;}
}					
```

```jsx
package Giocatore;
public class Giocatore {
	private String nome;
	private TipoLinkGioca gioca;
	
	public Giocatore(String n) {nome = n;}
	
	public String getNome() {return nome;}

	public void inserisciLinkGioca(TipoLinkGioca l) {
		if (l != null && l.getGiocatore() == this)
			ManagerGioca.inserisci(l);
	}
	public void eliminaLinkGioca(TipoLinkGioca l) {
		if (l != null && l.getGiocatore() == this)
			ManagerGioca.elimina(l);
	}
	public TipoLinkGioca getLinkGioca() {
		return gioca;
	}
	public void inserisciPerManagerGioca(ManagerGioca m) {
		if (m != null)
			gioca = m.getLink();
	}
	public void eliminaPerMAnagerGioca(ManagerGioca m) {
		if (m != null)
			gioca = null;
	}
}
```

```jsx
public class TipoLinkCompagno {
	private final Pilota pilota;
	private final Droide droide;

	public TipoLinkCompagno(Pilota p, Droide d) {
		if (p == null || d == null)
			throw new RuntimeException("link non valido");
		pilota = p;
		droide = d;
	}
	public Pilota getPilota() {return pilota;}
	public Droide getDroide() {return droide;}
	
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass())) {
			TipoLinkCompagno l = (TipoLinkCompagno) o;
			return l.pilota == pilota && l.droide == droide;
		}
		return false;
	}
	public int hashCode() {return pilota.hashCode() + droide.hashCode();}
}
```

```jsx
public final class ManagerCompagno {
	private TipoLinkCompagno link;
	private ManagerCompagno(TipoLinkComapgno l) {link = l;}
	public TipoLinkCompango getLink() {return link;}

	public static void inserisci(TipoLinkCompagno l) {
		if (l != null && l.getPilota().quantiCompagno() == 0 && l.getDroide().quantiCompagno() == 0) {
			ManagerCompagno m = new ManagerCompagno(l);
			l.getPilota().inserisciPerManagerCompagno(m);
			l.getDroide().inserisciPerManagerCompagno(m);
		}
	}
	public static void elimina(TipoLinkCompagno l) {
		if (l != null && l.getPilota().getLinkCompagno().equals(l)) {
			ManagerCompagno m = new ManagerCompagno(l);
			l.getPilota().eliminaPerManagerCompagno(m);
			l.getDroide().eliminaPerManagerCompagno(m);
		}
	}			
```

```jsx
package attivita_complesse;
public class AttivitaPrincipale implements Runnable {
	private boolean eseguita = false;
	private Gioco gioco;
	
	public AttivitaPrincipale(Gioco g) {gioco = g;}
	public void synchronized run() {
		if (eseguita) return;
		eseguita = true;
	
		Verifica v = new Verifica(gioco);
		TaskExecutor.getInstance().perform(v);
		boolean ok = v.getResult();
		
		if (!ok) {
			SegnaliIO.errore();
			return;
		}
		Gioca ramo1 = new Gioca(gioco);
		Thread t1 = new Thread(ramo1);
		t1.start();
		Analisi ramo2 = new Analisi(gioco);
		Thread t2 = new Thread(ramo2);
		t2.start();
		
		try {
			t1.join();
			t2.join();
		} catch(InterruptedExceptione e) {
			e.printStackTrace();
		}
		SegnaliIO.saluto();
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

```jsx
package attivita_complessa;
public class Gioca implements Runnable {
	private boolean eseguita = false;
	private Gioco gioco;
	
	public Gioca(Gioco g) {gioco = g;}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
	
		Avvia a = new Avvia(gioco);
		TaskExecutor.getInstance().perform(a);
		SegnaliIO.attesa();
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

```jsx
package attivita_complessa;
public class Analisi implements Runnable {
	private boolean eseguita = false;
	private Gioco gioco;
		
	public Analisi(Gioco g) {gioco = g;}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
		
		AnalisiAtomica aa = new AnalisiAtomica(gicco);
		TaskExecutor.getInstance().perform(aa);
		String report = aa.getResult();
		SegnaliIO.report(report);
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```
