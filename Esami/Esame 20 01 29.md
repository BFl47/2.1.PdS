# Esame 29.01.20

**SpecificaStatiClasse** Palla

Stati: {INATTIVA, ATTESA, MOVIMENTO, TEMPORANEO}

Variabili di stato ausiliarie: Buca b

Stato iniziale:
     Stato statocorrente = Stato.INATTIVO
     b = —;

**FineSpecificaClasse**

**SpecificaTransizioniClasse** Palla

Transizione: Inattiva → Attesa
     VaiInBuca(Buca){mitt: Giocatore}/Chiedi(){dest: Buca}

Evento: VaiInBuca(buca: Buca)

Condizione: nessuna;

Azione
     pre: nessuna
     post: nuovoevento = Chiedi(){dest = Buca}

Transizione: Attesa → Movimento
     Prenotata() {mitt: Buca}

Evento: Prenotata();

Condizione: buca.getLinkPrenotata() == null;

Azione:
     pre: nessuna
     post: nessuna

Transizione: Attesa → Inattiva
     /Fallimento() {dest: Giocatore}

Evento: —

Condizione: buca.getLinkPrenotata() ≠ null;

Azione:
     pre: nessuna
     post: nuovoevento = Fallimento() {mitt = this, dest = this.getLinkPossiede().getGiocatore()}
     

Transizione: Movimento→ Inattiva
     Raggiunta() {mitt: Buca}

Evento: Raggiunta()

Condizione: nessuna;

Azione:
     pre: nessuna
     post: this.getLinkPrenotata().getBuca() == buca && this.getPosizione() == buca.getPosizione();

Transizione: Movimento → Movimento
     Collisione(Palla) 

Evento: Collisione(p: Palla)

Condizione: this.getClass().equals(Pesante.class) && p.getClass().equals(Leggera.class);

Azione:
     pre: nessuna
     post: nessuna

Transizione: Movimento → Temporaneo
     Collisione(Palla)

Evento: Collisione(p: Palla)

Condizione: !(this.getClass().equals(Pesante.class) && p.getClass().equals(Leggera.class));

Azione:
     pre: nessuna
     post: nessuna

Transizione: Temporaneo → Inattiva
     Ferma(Posizione)

Evento: Ferma(int x, int y)

Condizione: nessuna

Azione:
     pre: nessuna
     post: this.getX() == x && this.getY() == y

**FineSpecifica**

**SegnaturaAttivitaComplesse**

AttivitaPrincipale(insieme(Giocatore) ins, Tavolo t) : ();

SottoAttivita1(insieme(Giocatore) ins, Tavolo t) : ();

SottoAttivita2(insieme(Giocatore) ins, Tavolo t) : (String report);

**SegnaturaAttivitaAtomiche**

Verifica(insieme(Giocatore) ins, Tavolo t) : (boolean ok);

**SegnaliIO**

Errore() : ();

Report(String report) : ();

**FineSegnatura**

```jsx
public abstract class Palla implements Listener {
	private String nome;
	private double x;
	private double y;

	private TipoLinkPrenotata linkPrenotata;
	private TipoLinkPossiede linkPossiede;
	public static final int MIN_POSSIEDE = 1;
	public int quantiPossiede() {
		if (linkPossiede == null) return 0;
		return 1;
	}
	public PallaRobotica(String n, double x, double y) {
		nome = n;
		this.x = x;
		this.y = y;
	}
	public String getNome() {return nome;}
	public void setX(double x) {this.x = x;}
	public void setY(double y) {this.y = y;}
	public double getX() {return x;}
	public double getY() {return y;}
	
	public void inserisciLinkPrenotata(TipoLinkPrenotata l) {
		if (l != null && l.getPalla() == this)
			ManagerPrenotata.inserisci(l);
	}
	public void eliminaLinkPrenotata(TipoLinkPrenotata l) {
		if (l != null && l.getPalla() == this)
			ManagerPrenotata.elimina(l);
	}
	public TipoLinkPrenotata getLinkPrenotata() {return linkPrenotata;}
	
	public void inserisciPerManagerPrenotata(ManagerPrenotata m) {
		if (m != null)
			linkPrenotata = m.getLink();
	}
	public void eliminaPerManagerPrenotata(ManagerPrenotata m) {
		if (m != null)
			linkPrenotata = null;
	}
	
	public void inserisciLinkPossiede(TipoLinkPossiede l) {
		if (l != null && l.getPalla() == this)
			ManagerPossiede.inserisci(l);
	}
	public void eliminaLinkPossiede(TipoLinkPossiede l) {
		if (l != null && l.getPalla() == this)
			ManagerPossiede.elimina(l);
	}
	public TipoLinkPossiede getLinkPossiede() {
		if (linkPossiede == null)
			throw new RuntimeException("violata molteplicità 1..1");
		return linkPossiede;
	}
	public void inserisciPerManagerPossiede(ManagerPossiede m) {
		if (m != null)
			linkPrenotata = m.getLink();
	}
	public void eliminaPerManagerPossiede(ManagerPossiede m) {
		if (m != null)
			linkPrenotata = null;
	}
	
	//gestione stato
	public static enum Stato = {INATTIVA, ATTESA, MOVIMENTO, TEMPORANEO};
	Stato statocorrente = Stato.INATTIVA;
	Buca b;
	public Stato getStato() {return statocorrente;}
	//gestione transizioni
	public void fired(Evento e) {
		TaskExecutor.getInstance().perform(new PallaFired(this, e));
	}	
		
```

```jsx
public class PallaFired implements Task {
	private boolean eseguita = false;
	private Palla palla;
	private Evento e;
	public PallaFired(Palla p, Evento e) {
		palla = p;
		this.e = e;
	}
	public synchronized void esegui() {
		if (eseguita || (e.getDestinatario != null && e.getDestinatario != palla))
			return;
		eseguita = true;
		
		switch(palla.getStato()) {
			case INATTIVA:
				if (e.getClass().equals(VaiInBuca.class)) {
						VaiInBuca vb = (VaiInBuca) e;
						palla.buca = vb.getPlayload();
						Chiedi c = new Chiedi(palla, palla.buca);
						Environment.addEvento(c);
						palla.statocorrente = Stato.ATTESA;
				}
				break;
			case ATTESA:
				if (e.getClass().equals(Prenotata.class)) {
						palla.statocorrente = Stato.MOVIMENTO;
				} else {
					Fallimento f = new Fallimento(palla, palla.getLinkPossiede().getGiocatore());
					Environment.addEvento(f);
					palla.statocorrente = Stato.INATTIVA;
				}
				break;
			case MOVIMENTO:
				if (e.getClass().equals(Raggiunta.class)) {
					Raggiunta r = (Raggiunta)e;
					Buca buca = r.getPlayload();
					palla.inserisciLinkPrenotata(new TipoLinkPrenotata(palla, buca));
					palla.setX(buca.getX());
					palla.setY(buca.getY));
					palla.statocorrente = Stato.INATTIVA;
				} else if (e.getClass().equals(Collisione.class)) {
					Collisione c = (Collisione) e;
					Palla palla2 = c.getPlayload();
					if (palla.getClass().equals(Pesante.class) && palla2.getClass().equals(Leggera.class)) {
						palla.statocorrente = Stato.MOVIMENTO;
					} else palla.statocorrente = Stato.TEMPORANEO;
				}
				break;
			case TEMPORANEO:
				if (e.getClass().equals(Ferma.class)) {
					Ferma f = (Ferma)e;
					palla.setX() = f.getX();
					palla.setY() = f.getY();
					palla.statocorrente = Stato.INATTIVA;
				}
				break;
			default: new RuntimeException("Stato non trovato");
		}
	}
	public synchronized boolean getEseguita() {return eseguita;}
}		
					
```

```jsx
public class TipoLinkPrenotata {
	private Palla palla;
	private Buca buca;
	public TipoLinkPrenotata(Palla p, Buca b) {
		if (p == null || b == null)
			throw new RuntimeException("link non valido");
		palla = p;
		buca = b;
	}
	public Palla getPalla() {return palla;}
	public Buca getBuca() {return buca;}
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass())) {
			TipoLinkPrenotata l = (TipoLinkPrenotata)o;
			return l.palla == palla && l.buca == buca;
		} else return false;
	}
	public int hashCode() {return palla.hashCode() + buca.hashCode();}
}
```

```jsx
public final class ManagerPrenotata {
	private TipoLinkPrenotata link;
	private ManagerPrenotata(TipoLinkPrenotata l) {link = l;}
	public TipoLinkPrenotata getLink() {return link;}
	public static void inserisci(TipoLinkPrenotata l) {
		if (l != null && l.getPalla().getLinkPrenotata() == null && l.getBuca().getLinkPrenotata() == null){
			ManagerPrenotata m = new ManagerPrenotata(l);
			l.getPalla().inserisciPerManagerPrenotata(m);
			l.getBuca().inserisciPerManagerPrenotata(m);
		}
	}
	public static void elimina(TipoLinkPrenotata l) {
		if (l != null && l.getPalla().getLinkPrenotata().equals(l)) {
			ManagerPrenotata m = new ManagerPrenotata(l);
			l.getPalla().eliminaPerManagerPrenotata(m);
			l.getBuca().eliminaPerManagerPrenotata(m);
		}
	}
}
```

```jsx
public class TipoLinkPossiede {
	private Giocatore gioc;
	private Palla palla;
	public TipoLinkPossiede(Giocatore g, Palla p) {
		if (g == null || p == null)
			throw new RuntimeException("link non valido");
		gioc = g;
		palla = p;
	}
	public Giocatore getGiocatore() {return gioc;}
	public Palla getPalla() {return palla;}
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass())) {
			TipoLinkPossiede l = (TipoLinkPossiede)o;
			return l.gioc == gioc && l.palla == palla;
		} else return false;
	}
	public int hashCode() {return gioc.hashCode() + palla.hashCode();}
}
```

```jsx
private final class ManagerPossiede {
	private TipoLinkPossiede link;
	private ManagerPossiede(TipoLinkPossiede l) {link = l;}
	public TipoLinkPossiede getLink() {return link;}
	public static void inserisci(TipoLinkPossiede l) {
		if (l != null && l.getPalla().quantiPossiede == 0) {
			ManagerPossiede m = new ManagerPossiede(l);
			l.getGiocatore().inserisciPerManager(m);
			l.getPalla().inserisciPerManager(m);
		}
	}
	public static void elimina(TipoLinkPossiede l) {
		if (l != null && l.getPalla().getLinkPossiede().equals(l)) {
			ManagerPossiede m = new ManagerPossiede(l);
			l.getGiocatore().eliminaPerManager(m);
			l.getPalla().eliminaPerManager(m);
		}
	}
}
```

```jsx
public class Pesante extends Palla {
	Pesante(String n, double x, double y) {super(n, x, y);}
}
```

```jsx
public class Leggera extends Palla {
	private String colore;
	Leggera(String n, double x, double y, String c) {
		super(n, x, y);
		colore = c;
	}
}
```

```jsx
public class AttivitaPrincipale implements Runnable {
	private boolean eseguita = false;
	private TipoLinkGioco gioco;
	
	public AttivitaPrincipale(TipoLinkGioco g) {
		this.gioco = g;
	}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
	
		Verifica v = new Verifica(gioco);
		TaskExecutor.getInstance().perform(v);
		boolean ok = v.getResult();
		
		if (!ok) {
			SegnaliIO.errore();
			return;
		}
			
		SottoAttivita1 ramo1 = new SottoAttivita1(gioco);
		Thread t1 = new Thread(ramo1);
		t1.start();
		SottoAttivita2 ramo2 = new SottoAttivita2(gioco);
		Thread t2 = new Thread(ramo2);
		t2.start();
		try {
			t1.join();
			t2.join();
		} catch(InterruptedException e) {
			e.printStackTrace();
		}
		String report = ramo2.getResult();
		SegnaliIO.report(report);
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

```jsx
public class SottoAttivita1 implements Runnable {
	private boolean eseguita = false;
	private TipoLinkGioco gioco;
	private TaskExecutor executor = TaskExecutor.getInstance();
	public SottoAttivita1(TipoLinkGioco g) {
		this.gioco = g;
	}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true; 
	
		AvviaGioco ag = new AvviaGioco(gioco);
		executor.perform(ag);
		Attesa a = new Attesa(gioco);
		executor.perform(a);
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

```jsx
public class SottoAttivita2 implements Runnable {
	private boolean eseguita = false;
	private Tavolo tavolo;
	private String ris;
	
	public SottoAttivita2(Tavolo t) {
		tavolo = t;
	}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
		
		Analisi a = new Analisi(Tavolo t);
		TaskExecutor.getInstance().perform(a);
		ris = a.getRis();
	}
	public synchronized boolean estEseguita() {return eseguita;}
	public synchronized String getRis(){
		if (!eseguita)
			throw new RuntimeException("SottoAttivita2 non eseguita");
		return ris;
	}
}
```