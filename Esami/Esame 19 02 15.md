# Esame 15.2.19

**SpecificaStatiClasse** Autista

Stati: {RIPOSO, GUIDA, ATTESA}

Variabili di stato ausiliarie: -

Stato iniziale:
   statocorrente = Stato.RIPOSO

**SpecificaTransizioniClasse** Autista

Transizione: Riposo → Guida
   richiesta(corsa)[patente idonea]

Evento: Richiesta(corsa: Corsa)

Condizione: this.getPatente() corrisponde alla patente richiesta da corsa.getMacchina()

Azione:
   pre: - 
   post: -

Transizione: Riposo → Guida
   richiestaSostituzione() {mitt: collega}/okSostituzione() {dest: collega}

Evento: RichiestaSostituzione

Condizione: -

Azione:
   pre: -
   post: nuovoevento == okSostituzione and destinatario == evento.getMittente()

Transizione: Guida → Riposo
   destinazione()

Evento: Destinazione

Condizione: -

Azione:
   pre: -
   post: -

Transizione: Riposo → Attesa
   richiesta(corsa)[!patente idonea]/sostituzione(){dest: this.chiediCollega()}

Evento: Richiesta(corsa: Corsa)

Condizione: this.getPatente() ≠ dalla patente richiesta da corsa.getMacchina()

Azione:
   pre: -
   post: nuovoevento == sostituzione and destinatario ==  this.chiediCollega()

Transizione: Attesa → Riposo
   okSostituzione() {mitt: sostituto}

Evento: OkSostituzione

Condizione: -

Azione: 
   pre: - 
   post: -

**FineSpecifica**

**SegnaturaAttivitaComplesse** 

AttivitaPrincipale(d: Deposito) : ();

Gestione(insAutisti: Insieme(Autista), insDisponibili: Insieme(Macchina)): ();

Manutenzione(insManutenzione: Insieme(Macchina)): (lista: stringa);

**SegnaturaAttivitaAtomiche**

DeterminaInsiemi(d: Deposito): (insDisponibili: Insieme(Macchina), insManutenzione: Insieme(Macchina));

AvviaPartenza(insAutisti: Insieme(Autista), insDisponibili: Insieme(Macchina)): ();

**SegnaturaAttivitaIO**

FineGiornata(): ();

Stampa(lista: stringa): ();

**FineSegnatura**

```jsx
package Autista;
public class Autista implements Listener {
	private final String nome;
	private String patente;
	private TipoLinkOpera opera;
	
	private final int MIN_OPERA = 1;
	public int quantiOpera() {
		if (opera == null) return 0;
		return 1;
	}
	public Autista(String n, String p) {
		nome = n;
		patente = p;
	}
	public String getNome() {return nome;}
	public String getPatente() {return patente;}
	public void setPatente(String p) {patente = p;}
	
	public void inserisciTipoLinkOpera(TipoLinkOpera l) {
		if (l != null && l.getAutista() == this)
			ManagerOpera.inserisci(l);
	}
	public void eliminaTipoLinkOpera(TipoLinkOpera l) {
		if (l != null && l.getAutista() == this)
			ManagerOpera.elimina(l);
	}
	public TipoLinkOpera getLinkOpera() {
		if (opera == null)
			throw new RuntimeException("violata cardinalità 1..1");
		return opera;
	}
	public void inserisciPerManagerOpera(ManagerOpera m) {
		if (m != null)
			opera = m.getLink();
	}
	public void eliminaPerManagerOpera(ManagerOpera m) {
		if (m != null)
			opera = null;
	}
	
	public enum static Stato = {RIPOSO, GUIDA, ATTESA};
	Stato statocorrente = Stato.RIPOSO;
	public Stato getStato() {return statocorrente;}
	
	public void fired(Evento e) {
		TaskExecutor.getInstance().peform(new AutistaFired(this, e));
	}	

	public void chiediCollega() {...}
}
```

```jsx
package Autista;
class AutistaFired implements Task {
	private boolean eseguita = false;
	private Autista autista;
	private Evento e;
	
	public AutistaFired(Autista a, Evento e) {
		autista = a;
		this.e = e;
	}
	public synchronized void esegui() {
		if (eseguita || e.getDestinatario() != null && e.getDestinatario() != autista)
			return;
		eseguita = true;
		String patente = autista.getPatente();
		switch(autista.getStato()) {
			case RIPOSO:
				if (e.getClass() == Richiesta.class) {
					Richiesta r = (Richiesta) e;
					Macchina m = r.getPlayload().getMacchina();
					if (m.getClass() == Lunga.class && patente.equals("D") || 
						m.getClass() == Pulmino.class && patente.equals("C")) 
						autista.statocorrente = Stato.GUIDA;
					else {
						Sostituzione s = new Sostituzione(autista, autista.chiediCollega());
						Environment.aggiungiEvento(s);
						autista.statocorrente = Stato.ATTESA;
					}
				}
				if (e.getClass() == RichiestaSostituzione.class) {
					RichiestaSostituzione rs = (RichiestaSostituzione)e;
					OkSostituzione ok = new OkSostituzione(autista, rs.getMittente());
					Environment.aggiungiEvento(ok);
					autista.statocorrente = Stato.GUIDA;
				}
				break;
			case GUIDA:
				if (e.getClass() == Destinazione.class) 
					autista.statocorrente = Stato.RIPOSO;
				break;
			case ATTESA:
				if (e.getClass() == OkSostituzione.class) 
					autista.statocorrente = Stato.RIPOSO;
				break;
			default: throw new RuntimeException("stato non trovato");
		}
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

Associazione “opera” (responsabilità doppia, 1..* ←-→ 1..1)

```jsx
public class TipoLinkOpera {
	private final Autista autista;
	private final Deposito deposito;
	public TipoLinkOpera(Autista a, Deposito d) {
		if (a == null || d == null) 
			throw new RuntimeException("link non valido");
		autista = a;
		deposito = d;
	}
	public Autista getAutista() {return autista;}
	public Deposito getDeposito() {return deposito;}
	
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass())) {
			TipoLinkOpera l = (TipoLinkOpera) e;
			return l.autista == autista && l.deposito == deposito;
		}
		return false;
	}
	public int hashCode() {return autista.hashCode() + deposito.hashCode();}
}
```

```jsx
public final class ManagerOpera {
	private TipoLinkOpera link;
	private ManagerOpera(TipoLInkOpera l) {link = l;}
	public TipoLinkOpera getLink() {return link;}
	
	public static void inserisci(TipoLinkOpera l) {
		if (l != null && l.getAutista().quantiOpera == 0) {
			ManagerOpera m = new ManagerOpera(l);
			l.getAutista().inserisciPerManagerOpera(m);
			l.getDeposito().inserisciPerManagerOpera(m);
		}
	}
	public static void elimina(TipoLinkOpera l) {
		if (l != null && l.getAutista().getLinkOpera().equals(l)) {
			ManagerOpera m = new ManagerOpera(l);
			l.getAutista().eliminaPerManagerOpera(m);
			l.getDeposito().eliminaPerManagerOpera(m);
		}
	}
}
```

```jsx
package attivita_complesse;
public class AttivitaPrincipale implements Runnable {
	private boolean eseguita = false;
	private Deposito d;
	
	public AttivitaPrincipale(Deposito d) {this.d = d;}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true,
		
		DeterminaInsieme di = new DeterminaInsiemi(d);
		TaskExecutor().getInstance().perform(di);
		HashSet<Macchina> insDisp = di.getDisponibili();
		HashSet<Macchina> insManut = di.getManutenzione();
		HashSet<Autista> insA = new HashSet<Autista>();
		
		for (TipoLinkOpera l: d.getLinkOpera()) 
			insA.add(l.getAutista());
		
		Gestione g = new Gestione(insA, insDisp);
		Thread t1 = new Thread(g);
		t1.start();
		Manutenzione m = new Manutenzione(insManut);
		Thread t2 = new Thread(m);
		t2.start();
		
		try {
			t1.join();
			t2.join();
		} catch(InterruptedExceptione e) {
			e.printStackTrace();
		}
		
		String report = m.getResult();
		SegnaliIO.stampa(report);
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

```jsx
package attivita_complesse;
public class Gestione implements Runnable {
	private boolean eseguita = false;
	private HashSet<Autista> insA;
	private HashSet<Macchina> insM;
	
	public Gestione(HashSet<Autista> insA, HashSet<Macchina> insM) {
		this.insA = insA;
		this.insM = insM;
	}
	public synchronized void run() {
		AvviaPartenza ap = new AvviaPartenza(insA, insM);
		TaskExecutor.getInstance().perform(ap);
		SegnaliIO.fineGiornata();
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

```jsx
package attivita_complesse;
public class Manutenzione implements Runnable {
	private boolean eseguita = false;
	private HashSet<Macchina> insM;
	private String result;
	
	public Manutenzione(HashSet<Macchina> insM) {this.insM = insM;}

	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
		
		ManutenzioneAtomica ma = new ManutenzioneAtomica(insM);
		TaskExecutor.getInstance().perform(ma);
		result = ma.getResult();
	}
	public synchronized void estEseguita() {return eseguita;}
	public synchronized String getResult() {
		if (!eseguita)
			throw new RuntimeException("attivita Manutenzione non eseguita");
		return result;
	}
}
```