# Esame 21.1.19

**SpecificaStatiClasse** Droide

Stati: {BASE, INATTESADICAPITANO, INVOLO}

Variabili di stato ausiliarie:\
&nbsp;&nbsp;&nbsp;&nbsp;   astronave: Astronave

Stato iniziale:\
&nbsp;&nbsp;&nbsp;&nbsp;   statocorrente = Stato.BASE\
&nbsp;&nbsp;&nbsp;&nbsp;    astronave: -

**SpecificaTransizioni**

Transizione: Base → InAttesaDiCapitano\
&nbsp;&nbsp;&nbsp;&nbsp;   volare(umano, astronave)[il droide fa parte dell’equipaggio dell’astronave]/richiestaCapitano(){dest: umano}

Evento: Volare(umano: Umano, astronave: Astronave)

Condizione: esiste un link “faparte1” tra il droide e l’equipaggio che pilota l’astronave

Azione:\
&nbsp;&nbsp;&nbsp;&nbsp;   pre: -\
&nbsp;&nbsp;&nbsp;&nbsp;   post: nuovoevento == richiestaSalire() {dest = umano} and droide.astronave == astronave

Transizione: InAttesaDiCapitano → InVolo\
&nbsp;&nbsp;&nbsp;&nbsp;   capitanoSalito() {mitt: umano}

Evento: CapitanoSalito()

Condizione: -

Azione:\
&nbsp;&nbsp;&nbsp;&nbsp;   pre: - \
&nbsp;&nbsp;&nbsp;&nbsp;   post: nuovo link “capitano” tra umano e astronave

Transizione: InVolo → Base\
&nbsp;&nbsp;&nbsp;&nbsp;   rientro()

Evento: Rientro()

Condizione: -

Azione:\
&nbsp;&nbsp;&nbsp;&nbsp;   pre:\
&nbsp;&nbsp;&nbsp;&nbsp;   post: droide.astronave == null

**FineSpecifica**

**SegnaturaAttivitaComplesse**

AttivitaPrincipale(G: Gioco): ();

SottoAttivita1(G: gioco) : ();

SottoAttivita2(G: Gioco): (report: stringa);

**SegnaturaAttivitaAtomiche**

Verifica(G: gioco): (ok: boolean);

AvviaGioco(insG: insieme(Giocatore)) : ();

Analisi(G: Gioco): (report: stringa);

**SegnaturaSegnaliIO**

Errore(): ();

AttesaFine() : ();

Report(report: stringa): ();

**FineSegnatura**

```jsx
package Droide;
public class Droide extends Giocatore implements Listener {
	private String modello;
	private HashSet<TipoLinkFaParte1> faparte;

	public Drone(String n, String m) {
		super(n);
		modello = m;
    		faparte = new HashSet<TipoLinkFaParte1>();
	}
	public String getModello() {return modello;}
	public void inserisciLinkFaParte1(TipoLinkFaParte1 l) {
		if (l != null && l.getDroide() == this) 
			ManagerFaParte1.inserisci(l);
	}
	public void eliminaLinkFaParte1(TipoLinkFaParte1 l) {
		if (l != null && l.getDroide() == this)
			ManagerFaParte1.elimina(l);
	}
	public Set<TipoLinkFaParte1> getLinkFaParte1() {
		return (HashSet<TipoLinkFaParte1>) faparte.clone();
	}
	public void inserisciPerManagerFaParte1(ManagerFaPArte1 m) {
		if (m != null)
			faparte.add(m.getLink());
	}
	public void eliminaPerManagerFaParte1(ManagerFaParte1 m) {
		if (m != null)
			faparte.remove(m.getLink());
	}
	
	//gestione stato
	public static enum Stato = {BASE, ATTESA, VOLO};
	Stato statocorrente = Stato.BASE;
	Astronave astronave;
	public Stato getStato() {return statocorrente;}
	
	//gestione transizioni
	public void fired(Evento e) {
		TaskExecutor.getInstance().perform(new DroideFired(this, e));
	}
```

```jsx
package Droide;
public class DroideFired implements Task {
	private boolean eseguita = false;
	private Droide droide;
	private Evento e;
	public DroideFired(Droide d, Evento e) {
		this.droide = d;
		this.e = e;
	}
	public synchronized void esegui() {
		if (eseguita || (e.getDestinatario != null && e.getDestinatario != droide))
			return;
		eseguita = true;
		
	switch(droide.getStato()) {
		case BASE:
			if (e.getClass() == Volare.class) {
				Volare v = (Volare)e;
				Astronave a = v.getAstronave();
				boolean ok;
				for (TipoLinkFaParte1 l: droide.getTipoLinkFaPArte1()) {
					Equipaggio eq = l.getEquipaggio();
					if (eq.getTipoLinkPilota().getAstronave() == a)
						ok = true;
				}
				if (ok) {
					RichiestaSalire rs = new RichiestaSalire(droide, v.getUmano());
					Environment.aggiungiEvento(rs);
					droide.astronave = a;
					droide.statocorrenteo = Stato.ATTESA;
				}
			}
			break;
		case ATTESA:
			if (e.getClass() == CapitanoSalito.class) {
				CapitanoSalito cs = (CapitanoSalito) e;
				cs.getMittente().setAstronave(droide.astronave); //associazione a reponsabilità singola
				droide.statocorrente = Stato.VOLO;
			}
			break;
		case VOLO:
			if (e.getClass() == Rientro.class) {
				droide.statocorrente = Stato.BASE;
				droide.astronave = null;
			}
			break;
		default: throw new RuntimeException("stato non riconosciuto");
	}
		
```

```jsx
package Giocatore;
public abstract class Giocatore {
	private String nome;
	private TipoLinkCostituito costituito;
	
	private final int MIN_COSTITUITO = 1;
	private int quantiCostituito() {
		if  (costituito == null) return 0;
		return 1;
	}
	public Giocatore(String n) {nome = n;}
	public String getNome() {return nome;}
	
	public void inserisciLinkCostituito(TipoLinkCostituito l) {
		if (l != null && l.getGiocatore == this)
			ManagerCostituito.inserisci(l);
	}
	public void eliminaLinkCostituito(TipoLinkCostituito l) {
		if (l != null && l.getGiocatore == this) 
			ManagerCostituito.elimina(l);
	}
	public TipoLinkCostituito getLinkCostituito() {
		if  (costituito == null)
			throw new RuntimeException("violata cardinalità 1..1");
		return costituito;
	}
	public void inserisciPerManagerCostituito(ManagerCostituito m) {
		if (m != null)
			costituito = m.getLink();
	}
	public void eliminaPerManagerCostituito(ManagerCostituito m) {
		if (m != null)
			costituito = null;
	}
}
```

Associazione “faparte1” (responsabilità doppia, 1..1 ←-→ 0..*)

```jsx
public class TipoLinkFaParte1 {
	private final Droide droide;
	private final Equipaggio equipaggio;
	
	public TipoLinkFaParte1(Droide d, Equipaggio e) {
		if (d == null || e == null)
			throw new RuntimeException("link non valido");
		droide = d;
		equipaggio = e;
	}
	public Droide getDroide() {return droide;}
	public Equipaggio getEquipaggio {return equipaggio;}
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass()) {
			TipoLinkFaParte1 l = (TipoLinkFaParte1) o;
			return l.droide == droide && l.equipaggio == equipaggio;
		}
		return false;
	}
	public int hashCode() {return droide.hashCode() + equipaggio.hashCode();}
}
```

```jsx
public final class ManagerFaParte1 {
	private TipoLinkFaParte1 link;
	private ManagerFaParte1(TipoLinkFaParte1 l) {link = l;}
	public TipoLinkFaParte1 getLink() {return link;}
	public static void inserisci(TipoLinkFaParte1 l) {
		if (l != null && l.getEquipaggio().quantiFaParte1() == 0) {
			ManagerFaParte1 m = new MAnagerFaParte1(l);
			l.getDroide().inserisciPerManagerFaParte1(m);
			l.getEquipaggio().inserisciPerManagerFaParte1(m);
		}
	}
	public static void elimina(TipoLinkFaParte1 l) {
		if (l != null && l.getEquipaggio().getLinkFaParte1().equals(l)) {
			ManagerFaParte1 m = new MAnagerFaParte1(l);
			l.getDroide().eliminaPerManagerFaParte1(m);
			l.getEquipaggio().eliminaPerManagerFaParte1(m);
		}
	}
			
```

Associazione “costituito” (responsabilità doppia, 0..* ←-→ 1..1)

```jsx
public class TipoLinkCostituito {
	private Giocatore giocatore;
	private Gioco gioco;
	
	public TipoLinkCostituito(Giocatore g, Gioco gg) {
		if (g == null || gg == null)
			throw new RuntimeException("link non valido");
		giocatore = g;
		gioco = gg;
	}
	public Giocatore getGiocatore() {return giocatore;}
	public Gioco getGioco() {return gioco;}
	
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass())) {
			TipoLinkCostituito l = (TipoLinkCostituito)o;
			return l.giocatore == giocatore && l.gioco == gioco;
	}
	public int hashCode() {return giocatore.hashCode() + gioco.hashCode();}
}
```

```jsx
public final class ManagerCostituito {
	private TipoLinkCostituito link;
	private ManagerCostituito(TipoLinkCostituito l) {link = l;}
	public TipoLinkCostituito getLink() {return link;}

	public static void inserisci(TipoLinkCostituito l) {
		if (l != null && l.getGiocatore().quantiCostituito == 0) {
			ManagerCostituito m = new ManagerCostituito(l);
			l.getGiocatore().inserisciPerManagerCostituito(m);
			l.getGioco().inserisciPerManagerCostituito(m);
		}
	}
	public static void elimina(TipoLinkCostituito l) {
		if (l != null && l.getGiocatore().getLinkCostituito().equals(l)) {
			ManagerCostituito m = new ManagerCostituito(l);
			l.getGiocatore().eliminaPerManagerCostituito(m);
			l.getGioco().eliminaPerManagerCostituito(m);
		}
	}
}
```

```jsx
package attivita_complesse;
public class AttivitaPrincipale implements Runnable {
	private boolean eseguita = false;
	private Gioco gioco;
	
	public AttivitaPrincipale(Gioco g) {
		gioco = g;
	}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = false;
		
		Verifica v = new Verifica(gioco);
		TaskExecutor.getInstance().perform(v);
		boolean ok = v.getResult();
		
		if (!ok) {
			SegnaliIO.errore();
			return;
		}
		
		SottoAttivita1 ramo1 = new SottoAttivita1(gioco);
		Thread t1 = new Thread(ramo1);
		t1.start();
		SottoAttivita2 ramo2 = new SottoAttivita2(gioco);
		Thread t2 = new Thread(ramo2);
		t2.start();
		
		try {
			t1.join();
			t2.join();
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		
		String report = ramo2.getResult();
		SegnaliIO.report(report);
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

```jsx
package attivita_complesse;
public class SottoAttivita1 implements Runnable {
	private boolean eseguita = false;
	private Gioco gioco;
	
	public SottoAttivita1(Gioco g) {gioco = g;}

	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;

		HashSet<Giocatore> giocatori = new HashSet<Giocatore>();
		for (TipoLinkCostituito l: gioco.getLinkCostituito()) 
			giocatori.add(l.getGiocatore());
		AvviaGioco ag = new AvviaGioco(giocatori);
		TaskExecutor.getInstance().perform(ag);
		SegnaliIO.attesaFine();
	}
	public synchronized boolean estEseguita() {return eseguita;}
}		
```

```jsx
package attivita_complesse;
public class SottoAttivita2 implements Runnable {
	private boolean eseguita = false;
	private Gioco gioco;
	private String result;
	
	public SottoAttivita2(Gioco g) {gioco = g;}
	
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
		
		Analisi a = new Analisi(gioco);
		TaskExecutor.getInstance().perform(a);
		result = a.getResult();
	}
	public synchronized String getResult() {
		if (!eseguita)
			throw new RuntimeException("SottoAttività2 non eseguita");
		return result;
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
	
	
```
