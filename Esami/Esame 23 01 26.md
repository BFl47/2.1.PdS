# Esame 26.1.23

**SpecificaStatiClasse** Raccolta

Stato: {INIZIALE, BOZZA, COMPLETA}

Variabili di Stato Ausiliarie:
     insiemeAutori insA
     Articolo articolo

StatoIniziale:
     statocorrente = Stato.INIZIALE
     ins_autori = —
     articolo = —

**FineSpecifica**

**SegnaturaAttivitàComplesse**

AttivitàPrincipale(insiemeAutori insA) : ()

Stampa(Saggio s) : (boolean ok)

PreparazioneMateriale(Saggio s) : (boolean ok)

**SegnaturaAttivitàAtomiche**

Verifica(Saggio s) : (boolean ok)

**SegnaturaAttivitàIO**

StampaErrore(): ()

**FineSegnatura**

**Realizzazione**

*Classe Raccolta* 

```jsx
package Raccolta;

public class Raccolta implements Listener {
private LinkedList<TipoLinkContiene> insLink;

public Raccolta(String titolo, int annoPubb) {
	super(titolo, annoPubb);
	insLink = new LinkedList<TipoLinkContiene>();
}
public void inserisciLinkContiene(TipoLinkContiene l) {
	if (l != null && l.getRaccolta() == this)
		ManagerContiene.inserisci(l);
}
public void eliminaLinkContiene(TipoLinkContiene l) {
	if (l != null && l.getRaccolta() == this)
		ManagerContiene.inserisci(l);
}
public List<TipoLinkContiene> getLinkContiene() {
	return (LinkedList<TipoLinkContiene>) insLink.clone();
}
public void inserisciPerManagerContiene(ManagerContiene m) {
	if (m != null && !insLink.contains(m.getLink())) {
		insLink.add(m.getLink());
}
public void eliminaPerManagerContiene(ManagerContiene m) {
	if (m != null)
		insLink.remove(m.getLink());
}

//gestione dello stato
public static enum Stato = {INIZIALE, BOZZA, COMPLETA};
Stato statocorrente = Stato.INIZIALE;
HashSet<Autore> insA;
Articolo articolo;
public Stato getStato() {return statocorrente;}

//gestione delle transizioni
public void fired(Evento e) {
	TaskExecutor.getInstance().perform(new RaccoltaFired(this, e));
}
```

```jsx
public class TipoLinkContiene {
	private Raccolta raccolta;
	private Articolo articolo;
	
	public TipoLinkContiene(Raccolta r, Articolo a) {
		if (r == null || a == null)
			throw new RuntimeException("link non valido");
	}
	public Raccolta getRaccolta() {return raccolta;}
	public Articolo getArticolo() {return articolo;}
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass())) {
			TipoLinkContiene l = (TipoLinkContiene) o;
			return l.raccolta == raccolta && l.articolo == articolo;
		} else return false;
	}
	public int hashCode() {return raccolta.hashCode() + articolo.hashCode();}
}
```

```jsx
public final class ManagerContiene {
	private TipoLinkContiene link;
	private ManagerContiene(TipoLinkContiene l) {link = l;}
	public TipoLinkContiene getLink() {return link;}
	public static void inserisci(TipoLinkContiene l) {
		if (l != null) {
			ManagerContiene m = new ManagerContiene(l); 
			l.getRaccolta().inserisciPerManagerContiene(m);
			l.getArticolo().inserisciPerManagerContiene(m);
		}
	}
	public static void elimina(TipoLinkContiene l) {
		if (l != null) {
			ManagerContiene m = new ManagerContiene(l);
			l.getRaccolta().eliminaPerManagerContiene(m);
			l.getArticolo().eliminaPerManagerContiene(m);
		}
	}
}

```

```jsx
public class RaccoltaFired implements Task {
	private boolean eseguita = false;
	private Raccolta raccolta;
	private Evento e;

	public RaccoltaFired(Raccolta r, Evento e) {
		raccolta = r;
		this.e = e;
	}
	public synchronized void esegui() {
		if (eseguita || (e.getDestinatario() != null && e.getDestinatario() != raccolta))
			return;
		eseguita = true;
		switch(raccolta.getStato()) {
			case INIZIALE:
				if (e.getClass().equals(Partenza.class)) {
					Partenza p = (Partenza) e;
					raccolta.insA = p.getPlayload();
					raccolta.statocorrente = Stato.BOZZA;
				}
				break;
			case BOZZA:
				if (e.getClass().equals(Sollecita.class)) {
					for (Autore autore: raccolta.insA) {
						if (autore.getLinkScrittoDa().getArticolo() == null) 
							Environment.nuovoEvento(new Notifica(raccolta, autore);
					}
					raccolta.statocorrente = Stato.BOZZA;
				}
				else if (e.getClass().equals(Aggiugni.class)) {
					Aggiungi a = (Aggiungi) e;
					raccolta.articolo = a.getPlayload();
					raccolta.inserisciLinkContiene(new TipoLinkContiene(raccolta, raccolta.articolo));
					HashSet<Autore> insAutori = new HashSet<Autore>();
					for(Autore autore: raccolta.insA) {
						Articolo art = autore.getLinkScritto().getArticolo();
						if (art != null && raccolta.getLinkContiene().contains(art))
							insAutori.add(autore);
					}
					if (insAutori.size() == raccolta.insA.size())
						raccolta.statocorrente = Stato.COMPLETA;
					else
						raccolta.statocorrente = Stato.BOZZA;
				}
				break;
			case COMPLETA:
				break;
			default: throw new RuntimeException("stato non trovato");
		}
	}
	public synchronized boolean estEseguita() {return eseguita;}
}	
```

```jsx
public class AttivitaPrincipale implements Runnable {
	private boolean eseguita = false;
	private HashSet<Saggio> insSaggi;
	
	public AttivitaPrincipale(HashSet<Saggio> ins) {
		insSaggi = ins;
	}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;

		int quantiSaggi = insSaggi.size();
		while (quantiSaggi != 0) {
			quantiSaggi--;
			Verifica v = new Verifica(s);
			TaskExecutor.getInstance().perform(v);
			boolean okVerifica = v.getResult();
			
			if (!okVerifica) continue;
			else {
				Stampa s = new Stampa(s);
				Thread t1 = new Thread(s);
				t1.start();
				PreparazioneMateriale pm = new PreparazioneMateriale(s);
				Thread t2 = new Thread(pm);
				t2.start();
				try {
					t1.join();
					t2.join();
				} catch(InterruptedExceptione e) {
					e.PrintStackTrace();
				}
				boolean okStampa = s.getResult();
				boolean okPrep = pm.getResult();
				if (okStampa && okPrep) return;	
			}
		}
		if (quantiSaggi == 0)
				SegnaliIO.stampaErrore();
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

```jsx
public class Verifica implements Task {
	private boolean eseguita = false;
	Saggio saggio;
	private boolean ok = false;
	
	public Verifica(Saggio s) {saggio = s;}
	public synchronized void esegui() {
		if (eseguita) return;
		eseguita = true;
		
		if (s.getClass().equals(Singolo.class)
			ok = true;
		else if (s.getClass().equals(Raccolta.class)) {
			Raccolta r = (Raccolta) saggio;
			if (r.getStato() == Stato.COMPLETA)
				ok = true;
		}
	}
	public synchronized boolean estEseguita() {return eseguita;}
	public synchronized boolean getResult() {return ok;}
}
```