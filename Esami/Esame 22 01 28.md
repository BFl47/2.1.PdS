# Esame 28.01.22

**SpecificaStatiClasse** Musicista

Stati: {ATTIVITA, PAUSA, DECEDUTO}

Variabili di stato ausiliarie: -

Stato iniziale:\
&nbsp;&nbsp;&nbsp;&nbsp;   Stato statocorrente = Stato.ATTIVITA

**FineSpecifica**

**SegnaturaAttivitaComplesse**

Principale(gruppo: GruppoMusicale): ();

Ottieni(gruppo: GruppoMusicale): (formazione: Formazione);

Scrittura(gruppo: GruppoMusicale): ();

Registrazione(gruppo: GruppoMusicale): ();

**SegnaturaAttivitaAtomiche**

Verifica(gruppo: GruppoMusicale): (ok: booleano);

RilasciaAnnuncio(gruppo: GruppoMusicale): (annuncio: stringa);

**SegnaturaSegnaliIO**

Stampa(): ();

**FineSegnatura**

```jsx
package Musicista;
public class Musicista implements Listener {
	private final String nome;
	private final int giorno, mese, anno;
	private HashSet<TipoLinkCostituita> costituita;
	private HashSet<TipoLinkSuona> suona;
	private final int MIN_COSTITUITA = 1;

	public Musicista(String n, int g, int m, int a) {
		nome = n;
		giorno = g;
		mese = m;
		anno = a;
		costituita = new HashSet<TipoLinkCostituita>();
		suona = new HashSet<TipoLinkSuona>();
	}
	public int quantiCostituita() {return costituita.size();}

	public String getNome() {return nome;}
	public int getGiornoNascita() {return giorno;}
	public int getMeseNascita() {return mese;}
	public int getAnnoNascita() {return anno;}

	public void inserisciLinkCostituita(TipoLinkCostituita l) {
		if (l != null && l.getMusicista() == this) 
			ManagerCostituita.inserisci(l);
	}
	public void eliminaLinkCostituita(TipoLinkCostituita l) {
		if (l != null && l.getMusicista() == this) 
			ManagerCostituita.elimina(l);
	}
	public Set<TipoLinkCostituita> getLinkCostituita() {
		if (quantiCostituita() < MIN_COSTITUITA)
			throw new RuntimeException("violata cardinalità 1..*");
		return (HashSet<TipoLinkCostituita>) costituita.clone();
	}
	public void inserisciPerManagerCostituita(ManagerCostituita m) {
		if (m != null)
			costituita.add(m.getLink());
	}
	public void eliminaPerManagerCostituita(ManagerCostituita m) {
		if (m != null)
			costituita.remove(m.getLink());
	}
	public void inserisciLinkSuona(TipoLinkSuona l) {
		if (l != null && l.getMusicista() == this)
			suona.add(l);
	}
	public void eliminaLinkSuona(TipoLinkSuona l) {
		if (l != null && l.getMusicista() == this)
			suona.remove(l);
	}
	public Set<TipoLinkSuona> getLinkSuona() {
		return (HashSet<TipoLinkSuona>)suona.clone();
	}
	
	public static enum Stato = {ATTIVITA, PAUSA, DECEDUTO};
	Stato statocorrente = Stato.ATTIVITA;
	public Stato getStato() {return statocorrente;}

	public void fired(Evento e) {
		TaskExecutor.getInstance().perform(new MusicistaFired(this, e));
	}
	
	public HashSet<Musicista> getMembri() {           
		HashSet<Musicista> musicisti = new HashSet<Musicista>();
		for (TipoLinkCostituita l1: musicista.getLinkCostituita()) {
			Formazione f = l1.getFormazione();
			if (f.getScioglimento() == -1) {
				for (TipoLinkCostituita l2: f.getLinkCostituita()) 
					musicisti.add(l2.getMusicista());
			}
		}
		return musicisti;
	}
}			
```

```jsx
package Musicista;
class MusicistaFired implements Task {
	private boolean eseguita = false;
	private Musicista musicista;
	private Evento e;
	
	public MusicistaFired(Musicista m, Evento e) {
		musicista = m;
		this.e = e;
	}
	public synchronized void esegui() {
		if (eseguita || e.getDestinatario() != null && e.getDestinatario() != musicista)
			return;
		eseguita = true;
		
		switch(musicista.getStato()) {
			case ATTIVITA:
				if (e.getClass() == VaiInPausa.class) {
					VaiInPausa vp = (VaiInPausa)e;
					String causa = vp.getPlayload();
					for (TipoLinkCostituita l1: musicista.getLinkCostituita()) {
						Formazione f = l.getFormazione();
						if (f.getScioglimento() == -1) {
							for (TipoLinkCostituita l2: f.getLinkCostituita()) 
								Environment.aggiungiEvento(new NotificaPausa(musicista, l2.getMusicista(), causa);
						}
					}
					musicista.statocorrente = Stato.PAUSA;
				}
				else if (e.getClass() == Muori.class) {
					for(TipoLinkCostituita l1: musicista.getLinkCostituita()) {
						Formazione f = l.getFormazione();
						if (f.getScioglimento() == -1) {
							for (TipoLinkCostituita l2: f.getLinkCostituita())
								Environment.aggiungiEvento(new NotificaMorte(musicista, l2.getMusicista());
						}
					}
					musicista.statocorrente = Stato.DECEDUTO;
				}
				break;
			case PAUSA:
				if (e.getClass() == Torna.class) {
					for (Musicista m: musicista.getMembri())
						Environment.aggiungiEvento(new NotificaRitorno(musicista, m));
					musicista.statocorrente = Stato.ATTIVITA;
				}
				else if (e.getClass() == Muori.class) {
					for (Musicista m: musicista.getMembri())
						Environment.aggiungiEvento(new NotificaMorte(musicista, m));
					musicista.statocorrente = Stato.DECEDUTO;
				}
				break;
			case DECEDUTO:
				break;
			default: throw new RuntimeException("stato non riconosciuto");
		}
	}
	public synchronized boolean estEseguita {return eseguita;}
}
```

Associazione costituita (responsabilità doppia, 1..* ←-→ 1..*, senza attributi)

```jsx
public class TipoLinkCostituita {
	private final Formazione formazione;
	private final Musicista musicista;
	
	public TipoLinkCostituita(Formazione f, Musicista m) {
		if (f == null || m == null)
			throw new RuntimeException("link non valido");
		formazione = f;
		musicista = m;
	}
	public Formazione getFormazione() {return formazione;}
	public Musicista getMusicista() {return musicista;}
	
	public boolean equals(Object o) {
		if (o != null && getClass().euqlas(o.getClass())) {
			TipoLinkCostituita l = (TipoLinkCostituita)o;
			return l.formazione == formazione && l.musicista == musicista;
		}
		return false;
	}
	public int hashCode() {return formazione.hashCode() + musicista.hashCode();}
}
```

```jsx
public final class ManagerCostituita {
	private TipoLinkCostituita link;
	private ManagerCostituita(TipoLinkCostituita l) {link = l;}
	public TipoLinkCostituita getLink() {return link;}
	
	public static void inserisci(TipoLinkCostituita l) {
		if (l != null) {
			ManagerCostituita m = new ManagerCostituita(l);
			l.getFormazione().inserisciPerManagerCostituita(m);
			l.getMusicista().inserisciPerManagerCostituita(m);
		}
	}
	public static void elimina(TipoLinkCostituita l) {
		if (l != null) {
			ManagerCostituita m = new ManagerCostituita(l);
			l.getFormazione().eliminaPErManagerCostituita(m);
			l.getMusicista().eliminaPerManagerCostituita(m);
		}
	}
}
```

Associazione suona(responsabilità singola, 0..* ←-→ 0..*, con un attributo)

```jsx
public class TipoLinkSuona {
	private final Musicista musicista;
	private final Strumento strumento;
	private final int daAnno;
	
	public TipoLinkSuona(Musicista m, Strumento s, int a) {
		if (m == null || s == null)
			throw new RuntimeException("link non valido");
		musicista = m;
		strumento = s;
		daAnno = a;
	}
	public Musicista getMusicista() {return musicista;}
	public Strumento getStrumento() {return strumento;}
	public int getDaAnno() {return daAnno;}
	
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass())) {
			TipoLinkSuona l = (TipoLinkSuona) o;
			return l.musicista == musicista && l.strumento == strumento;
		}
		return false;
	}
	public int hashCode() {return musicista.hashCode() + strumento.hashCode();}
}
```

```jsx
package attivita_complesse;
public class Principale implements Runnable {
	private boolean eseguita = false;
	private GruppoMusicale gruppo;
	
	public Principale(GruppoMusicale g) {gruppo = g;}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
		
		Verifica v = new Verifica(gruppo);
		TaskExecutor.getInstance().perform(v);
		boolean ok = v.getResult();
		
		if (!ok) {
			Ottieni o = new Ottieni(gruppo);
			Thread t0 = new Thread(o);
			t0.start();
		
			try {
				t0.join();
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}
		
		Scrittura ramo1 = new Scrittura(gruppo);
		Thread t1 = new Thread(ramo1);
		t1.start();
		Registrazione ramo2 = new Registrazione(gruppo);
		Thread t2 = new Thread(ramo2);
		t2.start();
		
		try {
			t1.join();
			t2.join();
		} catch(InterruptedException e) {
			e.printStackTrace();
		}
	
		RilasciaAnnuncio ra = new RilasciaAnnuncio(gruppo);
		TaskExecutor.getInstance().perform(ra);
		String annuncio = ra.getResult();
		SegnaliIO.stampa(annuncio);
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

```jsx
package attivita_atomiche;
public class Verifica implements Task {
	private boolean eseguita = false;
	private GruppoMusicale gruppo;
	private boolean ok = true;

	public Verifica(GruppoMusicale g) {gruppo = g;}
	public synchronized void esegui() {
		if (eseguita) return;
		eseguita = true;
	
		Formazione formazione;
		for (int i = gruppo.size()-1; i > 0; i--) {
			Formazione f = gruppo.getLinkRelativa(i).getFormazione();
			if (f.getScioglimento() == -1) {
				formazione = f;
				break;
			}
		}
		for (TipoLinkCostituita l: formazione.getLinkCostituita()) {
			Musicista m = l.getMusicista();
			if (m.getStato() != Musicista.Stato.ATTIVITA)
				ok = false;
		}
	}
	public synchronized boolean estEseguita() {return eseguita;}
	public synchronized boolean getResult() {
		if (!eseguita)
			throw new RuntimeException("attività verifica non eseguita");
		return ok;
	}
}
```
