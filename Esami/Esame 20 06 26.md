# Esame 26.6.20

**SpecificaStatiClasse** Richiesta

Stati: {CREATA, INVIATA, ATTESA, CHIUSA}

Variabili di stato ausiliarie: 
     Utente manutentore

Stato iniziale:
     Stato statoiniziale = Stato.CREATA
     manutentore = - -

**FineSpecifica**

**SpecificaTransizioniClasse** Richiesta

Transizione: Creata → Chiusa
     chiudi(){mitt: creatore, dest: this}

Evento: Chiudi()

Condizioni: creatore.equals(this.getCreatore())

Azione:
     pre: -
     post: -

Transizione: Creata → Inviata
     invia() {mitt: creatore, dest: this}

Evento: Invia()

Condizioni: creatore.equals(this.getCreatore())

Azione:
     pre: -
     post: -

Transizione: Inviata → Chiusa
     chiudi {mitt: manutentore, dest: this}

Evento: Chiudi()

Condizioni: this.getProgetto().getManutentori().contains(manutentore)

Azione:
     pre: -
     post: -

Transizione: Inviata → Attesa
     suggerimento{mitt: manutentore, dest: creatore}

Evento: Suggerimento()

Condizioni: this.getProgetto().getManutentori().contains(manutentore)

Azione:
     pre: -
     post: this.manutentore = suggerimento().getMittente() 

Transizione: Attesa → Chiusa
     chiudi() {mitt: creatore, dest: this} / notificaChiusura() {dest: manutentore}

Evento: Chiudi()

Condizione: creatore.equals(this.getCreatore())

Azione: 
     pre: -
     post: nuovoevento = notificaChiusura() {mitt = creatore, dest = manutentore}

Transizione: Attesa → Inviata
     modifica() {mitt: creatore} / notificaModifica() {dest: manutentore}

Evento: Modifica()

Condizione: creatore.equals(this.getCreatore())

Azione:
     pre: - 
     post = nuovoevento = notificaModifica() {mitt = creatore, dest = manutentore}

**FineSpecifica**

**SpecificaAttivita** AttivitaPrincipale

AttivitaPrincipale(p: Progetto) : ()

VariabiliAttivitaPrincipale
    p: Processo
    okVerifica: boolean
    okTest: boolean

InizioProcesso

Verifica(p) : (okVerifica);

if (!okVerifica) {

ErroreVerifica();

return;

}

fork {

thread t1: {

SottoAttivita1 (p) : (okTest);

}

thread t2: {

SottoAttivita2(p) : ();

}

}

join t1, t2;

if (!okTest) {

ErroreTest();

return;

}

Conferma();

FineProcesso

**SpecificaAttivita** SottoAttivita1

SottoAttivita1(p: Progetto) : (okTest: boolean)

Variabili di Processo
     p: Progetto
     okTest: boolean

InizioProcesso

Compilazione(p) : ();

Test(p) : (okTest);

FineProcesso

**SpecificaAttivita** SottoAttivita2

SottoAttivita2(p: Progetto) : ()

Variabili di processo
     p: Progetto

InizioProcesso

Assemblamento(p) : ()

FineProcesso

**SpecificaAttivitaAtomica** 

Verifica(p: Progetto) : (okVerifica: boolean)
     pre: -
     post: okVerifica è true se il progetto non contiene richieste bloccanti

Compilazione(p: Progetto) : ()
     pre: - 
     post: il progetto è compilato

Test(p: Progetto) : (okTest: boolean)
     pre: -
     post: okTest è true se il test è andato a buon fine

**SpecificaSegnaliIO** 

ErroreVerifica() : ()
     pre:
     post: si manda in output il messaggio “Errore verifica”

ErroreTest() : ()
     pre:
     post: si manda in output il messaggio “Errore test”

Conferma() : ()
     pre:
     post: si manda in output il messaggio “Conferma”

**FineSpecifica**

```jsx
public abstract class Richiesta implements Listener {
	private int codice;
	private String descrizione;
	
	private HashSet<File> insFile;
	private TipoLinkModifica linkModifica;
	private TipoLinkCreata linkCreata;
	
	public static final int MIN_MOLT = 1;
	public int quantiFile() {return insFile.size();}
	public int quantiModifica() {
		if (linkModifica == null)
			return 0;
		return 1;
	}
	public int quantiCreata() {
		if (linkCreata == null)
			return 0;
		return 1;
	}
	
	public Richiesta(int c, String d) {
		codice = c;
		descrizione = d;
		insFile = new HashSet<File>();
	}
	public int getCodice() {return codice;}
	public String getDescrizione() {return descrizione;}
	
	public void inserisciFile(File f) {
		if (f != null) insFile.add(f);
	}
	public void eliminaFile(File f) {
		if (f != null) insFile.remove(f);
	}
	public Set<File> getFile() {
		if (quantiFile() < MIN_MOLT)
			throw new RuntimeException("violata molteplicità 1..*");
		return (HashSet<File>) insFile.clone();
	}
	
	public void inserisciLinkModifica(TipoLinkModifica l) {
		if (l != null && l.getRichiesta() == this)
			ManagerModifica.inserisci(l);
	}
	public void eliminaLinkModifica(TipoLinkModifica l) {
		if (l != null && l.getRichiesta() == this)
			ManagerModifica.elimina(l);
	}
	public TipoLinkModifica getLinkModifica() {
		if (quantiModifica == 0)
			throw new RuntimeException("violata molteplicità 1..1");
		return linkModifica;
	}
	public void inserisciPerManagerModifica(ManagerModifica m) {
		if (m != null)
			linkModifica = m.getLink();
	}
	public void eliminaPerManagerModifica(ManagerModifica m) {
		if (m != null)
			linkModifica = null;
	}
	
	public void inserisciLinkCreata(TipoLinkCreata l) {
		if (l != null && l.getRichiesta() == this)
			ManagerCreata.inserisci(l);
	}
	public void eliminaLinkCreata(TipoLinkCreata l) {
		if (l != null && l.getRichiesta() == this)
			ManagerCreata.elimina(l);
	}
	public TipoLinkCreata getLinkCreata() {
		if (quantiCreata == 0)
			throw new RuntimeException("violata molteplicità 1..1");
		return linkCreata;
	}
	public void inserisciPerManagerCreata(ManagerCreata m) {
		if (m != null)
			linkCreata = m.getLink();
	}
	public void eliminaPerManagerCreata(ManagerCreata m) {
		if (m != null)
			linkCreata = null;
	}
	
	public stati enum Stato = {CREATA, INVIATA, ATTESA, CHIUSA};
	Stato statocorrente = Stato.CREATA;
	Utente manutentore;
	public Stato getStato() {return statocorrente;}
	
	public void fired(Evento e) {
		TaskExecutor.getInstance().perform(new RichiestaFired(this, e));
	}
}
```

```jsx
public class RichiestaFired implements Task {
	private boolean eseguita = false;
	private Richiesta richiesta;
	private Evento e;
	
	public RichiestaFired(Richiesta r, Evento e) {
		richiesta = r;
		this.e = e;
	}
	public synchronized void esegui() {
		if (eseguita || (e.getDestinatario() != null && e.getDestinatario() != richiesta))
			return;
		eseguita = true;
		
		switch (richiesta.getStato()) {
			case CREATA:
				if (e.getClass().equals(Chiudi.class))
					richiesta.statocorrente = Stato.CHIUSA;
				else if (e.getClass().equals(Invia.class)
					richiesta.statocorrente = Stato.INVIATA;
				break;
			case INVIATA:
				if (e.getClass().equals(Chiudi.class)) 
					richiesta.statocorrente = Stato.CHIUSA;
			  else if (e.getClass().equals(Suggerimento.class)) {
					Suggerimento s = (Suggerimento) e;
					richiesta.manutentore = s.getMittente();
					richiesta.statocorrente = Stato.ATTESA;
				}
				break;
			case ATTESA:
				if (e.getClass().equals(Chiudi.class)) {
					NotificaChiusura n = new NotificaChiusura(richiesta, richiesta.manutentore);
					Environment.aggiungiEvento(n);
					richiesta.statocorrente = Stato.CHIUSA;
				}
				else if (e.getClass().equals(Modifica.class)) {
					NotificaModifica n = new NotificaModifica(richiesta, richiesta.manutentore);
					Environment.aggiungiEvento(n);
					richiesta.statocorrente = Stato.INVIATA;
				}
				break;
			case CHIUSA:
				break;
			default: throw new RuntimeException("Stato non trovato");
		}
	}
	public synchronized boolean estEseguita() {return eseguita;}
}

```

```jsx
public class TipoLinkModifica {
	private Richiesta richiesta;
	private Progetto progetto;
	
	public TipoLinkModifica(Richiesta r, Progetto p) {
		if (r == null || p == null)
			throw new RuntimeException("link non valido");
		richiesta = r;
		progetto = p;
	}
	public Richiesta getRichiesta() {return richiesta;}
	public Progetto getProgetto() {return progetto;}
	
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass()) {
			TipoLinkModifica l = (TipoLinkModifica) o;
			return l.richiesta == richiesta && l.progetto == progetto;
		} else return false;
	}
	public int hashCode() {return richiesta.hashCode() + progetto.hashCode();}
}
```

```jsx
public final class ManagerModifica {
	private TipoLinkModifica link;
	private ManagerModifica(TipoLinkModifica l) {link = l;}
	public TipoLinkModifica getLink() {return link;}

	public static void inserisci(TipoLinkModifica l) {
		if (l != null && l.getRichiesta().quantiModifica() == 0) {
			ManagerModifica m = new ManagerModifica(l);
			l.getRichiesta().inserisciPerManagerModifica(m);
			l.getProgetto().inserisciPerManagerModifica(m);
		}
	}
	public static void elimina(TipoLinkModifica l) {
		if (l != null && l.getRichiesta().getLinkModifica().equals(l)) {
			ManagerModifica m = new ManagerModifica(l);
			l.getRichiesta().eliminaPerManagerModifica(m);
			l.getProgetto().eliminaPerManagerModifica(m);
		}
	}
}
```

```jsx
public class TipoLinkCreata {
	private Richiesta richiesta;
	private Utente creatore;
	public TipoLinkCreata(Richiesta r, Utente c) {
		if (r == null || c == null)
			throw new RuntimeException("link non valido");
		richiesta = r;
		creatore = c;
	}
	public Richiesta getRichiesta() {return richiesta;}
	public Utente getCreatore() {return creatore;}
	public boolean equals(Object o) {
		if (o != null && getClass().equals(o.getClass())) {
			TipoLinkCreata l = (TipoLinkCreata) o;
			return l.richiesta == richiesta && l.creatore == creatore;
		}
	}
	public int hashCode() {return richiesta.hashCode() + creatore.hashCode();}
}
```

```jsx
public final class ManagerCreata {
	private TipoLinkCreata link;
	private ManagerCreata(TipoLinkCreata l) {link = l;}
	public TipoLinkCreata getLink() {return link;}

	public static void inserisci(TipoLinkCreata l) {
		if (l != null && l.getRichiesta().quantiCreata() == 0) {
			ManagerCreata m = new ManagerCreata(l);
			l.getRichiesta().inserisciPerManagerCreata(m);
			l.getCreatore().inserisciPerManagerCreata(m);
		}
	}
	public static void elimina(TipoLinkCreata l) {
		if (l != null && l.getRichiesta().getLinkCreata().equals(l)) {
			ManagerCreata m = new ManagerCreata(l);
			l.getRichiesta().eliminaPerManagerCreata(m);
			l.getCreatore().eliminaPerManagerCreata(m);
		}
	}
}
```

```jsx
public class AttivitaPrincipale implements Runnable {
	private boolean eseguita = false;
	private Progetto p;
	public AttivitaPrincipale(Progetto p) {this.p = p;}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
		
		Verifica v = new Verifica(p);
		TaskExecutor.getInstance().perform(v);
		boolean okVerifica = v.getResult();
		
		if (!okVerifica) {
			SegnaliIO.erroreVerifica();
			return;
		}
		SottoAttivita1 ramo1 = new SottoAttivita1(p);
		Thread t1 = new Thread(ramo1);
		t1.start();
		
		SottoAttivita2  ramo2 = new SottoAttivita2(p);
		Thread t2 = new Thread(ramo2);
		t2.start();
		
		try {
			t1.join();
			t2.join();
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
		boolean okTest = ramo1.getResult();
		if (!okTest) {
			SegnaliIO.erroreTest();
			return;
		}
		SegnaliIO.conferma();
	}
	public synchronized boolean estEseguita() {return eseguita;}
}

```

```jsx
public class SottoAttivita1 implements Runnable {
	private boolean eseguita = false;
	private Progetto p;
	private boolean result;
	private TaskExecutor executor = TaskExecutor.getInstance();
	
	public SottoAttivita1(Progetto p) {this.p = p;}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
			
		Compilazione c = new Compilazione(p);
		executor.perform(c);
		Test t = new Test(p);
		executor.perform(t);
		result = t.getResult();
	}
	public synchronized boolean getResult() {
		if (!eseguita)
			throw new RuntimeException("SottoAttivita1 non ancora eseguita");
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```

```jsx
public class SottoAttivita2 implements Runnable {
	private boolean eseguita = false;
	private Progetto p;
	public SottoAttivita2(Progetto p) {this.p = p;}
	public synchronized void run() {
		if (eseguita) return;
		eseguita = true;
		
		Assemblaggio a = new Assemblaggio(p);
		TaskExecutor.getInstance().perform(a);
	}
	public synchronized boolean estEseguita() {return eseguita;}
}
```